Menu="Buttons:197"
Link="nav-user"
---
<?
/* Copyright Derek Macias (parts of code from NUT package)
 * Copyright macester (parts of code from NUT package)
 * Copyright gfjardim (parts of code from NUT package)
 * Copyright SimonF (parts of code from NUT package)
 * Copyright Dan Landon (parts of code from Web GUI)
 * Copyright Bergware International (parts of code from Web GUI)
 * Copyright Lime Technology (any and all other parts of Unraid)
 *
 * Copyright desertwitch (as author and maintainer of this file)
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License 2
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 */
require_once '/usr/local/emhttp/plugins/dwsnap/include/dwsnap_config.php';
?>

<?if(version_compare(parse_ini_file('/etc/unraid-version')['version'],'6.12.0-beta5', '>')):?>
<?if(stripos($path, "dashboard") !== false && $dwsnap_dashboards == "enable"):?>
<style type="text/css">
.snapdash {
    font-size: 1.2rem;
}
</style>
<?
try {
    $snap_cfgs = dwsnap_get_conf_files() ?? [];
    $snap_cfg_counter = 0;

    foreach ($snap_cfgs as $snap_cfg) {
        $snap_cfg_counter = $snap_cfg_counter + 1;
        $snap_cfg_name = basename($snap_cfg,".conf");
        $snap_cfg_name_upper = strtoupper($snap_cfg_name);
        $snap_cfg_obj = new SnapraidArrayConfiguration($snap_cfg_name);

        if($snap_cfg_obj->dashboard == "enable") {
            $pluginname = "snap" . $snap_cfg_counter; 
            $mytiles[$pluginname]['column2'] = <<<EOT
            <tbody id="$pluginname" title="SnapRAID: $snap_cfg_name_upper">
            <tr><td>
            <i class="icon-disks f32"></i>
            <div class="section">SnapRAID: $snap_cfg_name_upper<br>
            <span class='snaphead' name='$snap_cfg_name'>Array Status: <i class="fa fa-spinner fa-spin"></i> <em>Please wait, retrieving information...</em></span><br></div>
            </td></tr>
            <tr class='header'><td><span class='w18'>Parity Disks</span><span class='w18'>Data Disks</span><span class='w18'>Maintenance</span><span class='w26'>Last Snapshot (Sync)</span><span class='w18'>Last Scrub</span></td></tr>
            <tr class='snapdash' name='$snap_cfg_name'><td style="text-align:center;"><i class="fa fa-spinner fa-spin"></i> <em>Please wait, retrieving information...</em></td></tr>
            </tbody>
EOT;
        }
        unset($snap_cfg_obj);
    }
} catch (Throwable $e) { // For PHP 7
    // do nothing
} catch (Exception $e) { // For PHP 5
    // do nothing
}
?>
<script type="text/javascript">
function getSnapDashboards() {
    $( ".snapdash" ).each(function() {
        var cfg = $(this).attr('name');
        $.get('/plugins/dwsnap/include/dwsnap_dashboard.php', {"config": cfg}, function(data) {
            if (data) {
                var snapDashResponse = data.split(","); 
                $('.snaphead[name="'+cfg+'"]').html(snapDashResponse[0]);
                $('.snapdash[name="'+cfg+'"]').html(snapDashResponse[1]);
                $('.snapdashtip').tooltipster();
                $('.snapdashhtmltip').tooltipster({contentAsHTML: true});
            }
        });
    });
    clearTimeout(timers.getSnapDashboards);
    timers.getSnapDashboards = setTimeout(getSnapDashboards, 10000);
}
$(function()
{
    getSnapDashboards();
});
</script>
<?endif;?>
<?endif;?>

<?if($dwsnap_footer == "enable"):?>
<style type="text/css">
#snap_footer {
    float: right;
    margin-right: 24px;
    font-size: 1.1rem;
    cursor: pointer;
}
#snap_footer i {
    margin-left: 5px;
}
</style>

<script type="text/javascript">
function getSnapFooter() {
    $.get('/plugins/dwsnap/include/dwsnap_footer.php',function(data) {
        if (data) { 
            $('#snap_footer').html(data);
            $('.snapfootertip').tooltipster();
            $('#snap_footer').click(function() {
                location = '/Settings/dwsnapOps';
            });
	    }
    });
    clearTimeout(timers.getSnapFooter);
    timers.getSnapFooter = setTimeout(getSnapFooter, 3000);
}
$(function()
{
    var snap_footer = $("<span id='snap_footer'></span>").insertAfter("div#footer > span#copyright");
    getSnapFooter();
});
</script>
<?endif;?>
