Menu="OtherSettings"
Type="xmenu"
Title="SnapRAID"
Icon="hdd-o"
Tag="hdd-o"
Markdown="false"
---
<?
$snapraid_lastcmd = (file_exists("/var/log/snapraid/lastcmd") ? (file_get_contents("/var/log/snapraid/lastcmd") ?? "n/a") : "n/a");
?>

<style type="text/css">
.snaplog {
    height: 400px;
    max-height: 400px;
    overflow: auto;
    background-color: #eeeeee;
    word-break: normal !important;
    word-wrap: normal !important;
    white-space: pre !important;
}
</style>

<table class="tablesorter shift">
<thead><tr><th><strong>(Last) Operation's Terminal</strong></th><th style="text-transform: none;">
<strong>(Last) Operation's Command:</strong> <em><?=$snapraid_lastcmd?></em>
<span style="float:right;"><strong>Refresh Terminal:</strong> <i id="logcontrol" class="fa fa-refresh fa-spin"></i></span>
</th></tr></thead>
</table>

<span id="logviewer"></span>

<form markdown="0" id="snapcommands" name="snapcommands" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" id="command" name="#command" value="">
<input class="snaprun" type="button" id="snapstatus" value="STATUS">
<input class="snaprun" type="button" id="snapdiff" value="DIFF">
<input class="snaprun" type="button" id="snapsync" value="SYNC">
<input class="snaprun" type="button" id="snapscrub" value="SCRUB">
<input class="snaprun" type="button" id="snaptouch" value="TOUCH">
<input class="snaprun" type="button" id="snapcheck" value="CHECK">
<input class="snaprun" type="button" id="snapfix" value="FIX">
<input class="snaprun" type="button" id="snapfixerrors" value="FIX ERRORS">
<input class="snapnotrun" type="button" id="snapstop" value="STOP OPERATION" style="float:right;margin-right:10px">
</form> 

<script type="text/javascript">
function getSnapLogs() {
    $.get('/plugins/dwsnap/include/dwsnap_logger.php',function(data) {
        if (data) { 
            $('#logviewer').html(data); 
	        var pre = $(".snaplog");
	        pre.scrollTop(pre.prop("scrollHeight"));
	    }
    });
    clearTimeout(timers.getSnapLogs);
    timers.getSnapLogs = setTimeout(getSnapLogs, 1000);
}
function getSnapStatus() {
    $('#progress').remove();
    showStatus('snapraid');
    $.get('/plugins/dwsnap/include/dwsnap_status.php',function(data) {
        if (data) { 
            if(data === "RUNNING:YES") {
                $('.snaprun').prop('disabled', true);
                $('.snapnotrun').prop('disabled', false);
            } else if (data === "RUNNING:NO") {
                $('.snaprun').prop('disabled', false);
                $('.snapnotrun').prop('disabled', true);
                $('#logcontrol').attr("class", "fa fa-refresh");
                clearTimeout(timers.getSnapLogs);
            }
	    }
    });
    clearTimeout(timers.getSnapStatus);
    timers.getSnapStatus = setTimeout(getSnapStatus, 3000);
}
function toggleSnapLogs() {
    if($('#logcontrol').attr("class") == "fa fa-refresh fa-spin") {
        $('#logcontrol').attr("class", "fa fa-refresh");
        clearTimeout(timers.getSnapLogs);
    } else {
        $('#logcontrol').attr("class", "fa fa-refresh fa-spin");
        getSnapLogs();
    }
}
$(function(){
    $('#logcontrol').click(toggleSnapLogs);

    $('#snapstatus').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/status');
        $('#snapcommands').submit();
    });
    $('#snapdiff').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/diff');
        $('#snapcommands').submit();
    });
    $('#snapsync').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/sync');
        $('#snapcommands').submit();
    });
    $('#snapscrub').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/scrub');
        $('#snapcommands').submit();
    });
    $('#snaptouch').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/touch');
        $('#snapcommands').submit();
    });
    $('#snapcheck').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/check');
        $('#snapcommands').submit();
    });
    $('#snapfix').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/fix');
        $('#snapcommands').submit();
    });
    $('#snapfixerrors').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/fixerrors');
        $('#snapcommands').submit();
    });
    $('#snapstop').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/stop');
        $('#snapcommands').submit();
    });

    getSnapStatus()
    getSnapLogs();

    // dynamix plugin update api
    <?if (function_exists('plugin_update_available') && $version = plugin_update_available('dwsnap')):?>
        showNotice('SnapRAID <?=htmlspecialchars($version);?> available. <a>Update</a>','dwsnap');
        $('#user-notice a').on('click', function () {
        $('#user-notice').empty();
    });
    <?endif;?>
});
</script>
