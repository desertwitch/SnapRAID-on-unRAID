Menu="OtherSettings"
Type="xmenu"
Title="SnapRAID"
Icon="scissors"
Tag="scissors"
Markdown="false"
---
<?
/* Copyright Derek Macias (parts of code from NUT package)
 * Copyright macester (parts of code from NUT package)
 * Copyright gfjardim (parts of code from NUT package)
 * Copyright SimonF (parts of code from NUT package)
 * Copyright desertwitch
 *
 * Copyright Dan Landon
 * Copyright Bergware International
 * Copyright Lime Technology
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License 2
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 */
require_once '/usr/local/emhttp/plugins/dwsnap/include/dwsnap_config.php';
$snap_lastsync_html = "-";
$snap_lastscrub_html = "-";
if($dwsnap_lastsync !== "-") { $snap_lastsync_html = $dwsnap_lastsync . " (<strong>" . dwsnap_time_ago($dwsnap_lastsync) . "</strong>)"; } else { $snap_lastsync_html = "<span class='orange-text'><strong>Never</strong></span>"; }
if($dwsnap_lastscrub !== "-") { $snap_lastscrub_html = $dwsnap_lastscrub . " (<strong>" . dwsnap_time_ago($dwsnap_lastscrub) . "</strong>)"; } else { $snap_lastscrub_html = "<span class='orange-text'><strong>Never</strong></span>"; }
?>

<style type="text/css">
.snaplog {
    height: 400px;
    max-height: 400px;
    overflow: auto;
    word-break: normal !important;
    word-wrap: normal !important;
    white-space: pre !important;
    <?if($dwsnap_screenimg == "enable"):?>
    background: transparent url("<?=($display["theme"] == 'white' || $display["theme"] == 'azure') ? "/plugins/dwsnap/images/screen.png" : "/plugins/dwsnap/images/screen-alt.png";?>") no-repeat scroll center;
    <?endif;?> 
}
.snapdisks tr:nth-child(2) > th {
    text-align: center !important;
}
.snapdisks td {
    text-align: center !important;
}
.snapdisks input {
    height: 30px;
    font-size: x-small;
}
.snapdisktype {
    font-family: bitstream;
    font-size: 1.1rem;
}
</style>

<table class="tablesorter shift" autofocus>
    <thead>
        <tr>
            <th><i id="snapstatusicon" class="fa fa-cog fa-spin" style="display:none;"></i> <strong>Array Operation Screen</strong></th>
            <th style="text-transform: none;"><strong>Started:</strong> <em><?=$dwsnap_laststart?></em></th>
            <th style="text-transform: none;"><strong>Finished:</strong> <em><?=$dwsnap_lastfinish?></em><span style="float:right;"><strong>Refresh:</strong> <i id="logcontrol" class="fa fa-refresh fa-spin"></i></span></th>
        </tr>
    </thead>
</table>

<span id="logviewer"><div style="text-align:center;"><i class="fa fa-spinner fa-spin"></i> <em>Please wait, retrieving information...</em></div></span>

<form markdown="0" id="snapcommands" name="snapcommands" method="POST" action="/update.php" target="progressFrame">
    <input type="hidden" id="command" name="#command" value="">
    <input type="hidden" id="arg1" name="#arg[1]" value="">
    <input type="hidden" id="arg2" name="#arg[2]" value="">
    <input type="hidden" id="arg3" name="#arg[3]" value="">
    <input type="hidden" id="arg4" name="#arg[4]" value="">
    <input type="hidden" id="arg5" name="#arg[5]" value="">
    <input type="hidden" id="arg6" name="#arg[6]" value="">
    <input type="hidden" id="arg7" name="#arg[7]" value="">
    <input type="hidden" id="arg8" name="#arg[8]" value="">
    <input type="hidden" id="arg9" name="#arg[9]" value="">
    <input type="hidden" id="arg10" name="#arg[10]" value="">
    <input type="hidden" id="arg11" name="#arg[11]" value="">
    <input type="hidden" id="arg12" name="#arg[12]" value="">
    <input type="hidden" id="arg13" name="#arg[13]" value="">
    <input type="hidden" id="arg14" name="#arg[14]" value="">
    <input type="hidden" id="arg15" name="#arg[15]" value="">

    <input class="snaprun snaphelptip" type="button" id="snapstatus" value="STATUS" title="Prints a summary of the state of the disk array. It includes information about the parity fragmentation, how long the blocks have not been checked, and all the recorded silent errors encountered while scrubbing. Note that the information presented refers to the last time you ran SYNC. Later modifications to the array data are not taken into account.">
    <input class="snaprun snaphelptip" type="button" id="snaplist" value="LIST" title="Lists all the files contained in the array at the time of the last SYNC.">
    <input class="snaprun snaphelptip" type="button" id="snapdiff" value="DIFF" title="Lists all the files modified since the last SYNC and not part of the snapshot in this state. This command doesn't check the file data, but only the file time-stamp size and inode (compared against the snapshot).">
    <input class="snaprun snaphelptip" type="button" id="snapdup" value="DUP" title="Lists all the duplicate files. Two files are assumed equal if their hashes are matching.">
    <input class="snaprun snaphelptip" type="button" id="snapscrub" value="SCRUB" title="Scrubs the array, checking for silent or input/output errors in data and parity disks. For each default command invocation, about 8% of the array is checked, but nothing that was already scrubbed in the last 10 days.">
    <input class="snaprun snaphelptip" type="button" id="snapcheck" value="CHECK" title="Verify all the files and the parity data. It works like FIX, but it only simulates a recovery and no changes are written.">

    <span style="float:right;">
        <input class="snaprun snaphelptip" type="button" id="clearoutput" value="CLEAR SCREEN" title="Clears the output screen of the current/previous array operation.">
        <input class="snaprun snaphelptip" type="button" id="clearlogs" value="CLEAR ALL LOGS" title="Deletes all SnapRAID log files, also including the output screen of the current/previous array operation.">
        <input class="snapnotrun snaphelptip" type="button" id="snapstop" value="STOP OPERATION" title="Attempts to (gracefully) stop all running SnapRAID instances.">
        <input class="snapnotrun snaphelptip" type="button" id="snapkill" value="KILL OPERATION" title="After a last attempt of (gracefully) stopping all running SnapRAID instances, this action hard-kills all still running SnapRAID instances with SIGKILL, beware that DATA CORRUPTION is very possible with this action.">
    </span><br>

    <input class="snaprun snaphelptip" type="button" id="snapsync" value="SYNC" title="Updates the parity information. All the modified files in the disk array are read, and the corresponding parity data is updated. This is the equivalent of taking a snapshot, which will be the base for all recoveries.">
    <input class="snaprun snaphelptip" type="button" id="snaphashedsync" value="PREHASHED SYNC" title="Updates the parity information. All the modified files in the disk array are read, and the corresponding parity data is updated. This is the equivalent of taking a snapshot, which will be the base for all recoveries. A preliminary hashing phase of all the new data, to have an additional verification before the actual parity computation, is performed.">
    <input class="snaprun snaphelptip" type="button" id="snaptouch" value="TOUCH" title="Sets arbitrarily the sub-second time-stamp of all the files that have it at zero. This improves the SnapRAID capability to recognize moved and copied files as it makes the time-stamp almost unique, mitigating possible duplicates.">
    <input class="snaprun snaphelptip" type="button" id="snapfix" value="FIX" title="Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it's reverted to the stored snapshot. The FIX command doesn't differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC. If no other option is specified the full array is processed. Use the filter options to select a subset of files or disks to operate on if you do not want this.">
    <input class="snaprun snaphelptip" type="button" id="snapfixmissing" value="FIX MISSING" title="Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it's reverted to the stored snapshot. The FIX command doesn't differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC. Only all files missing or deleted from the array are processed by this specific command.">
    <input class="snaprun snaphelptip" type="button" id="snapfixerrors" value="FIX ERRORS" title="Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it's reverted to the stored snapshot. The FIX command doesn't differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC. Only files that have blocks marked with silent or input/output errors during previous SYNC and SCRUB operations are processed by this command.">

    <span style="float:right;">
        <input class="snaprun snaphelptip" type="button" id="crontest" value="RUN MAINTENANCE CRONJOB" title="Runs the SnapRAID maintenance now.">
    </span><br>

    <div id="snapopts"> 
        <strong>Event Notifications:</strong>
        <input type="checkbox" id="snap-notifyme" value="snap-notifyme">
        <label for="snap-notifyme" title="Sends a notification when the manually started array operation finishes (using Unraid's system-wide notification settings)." class="snaphelptip">On Operation Complete</label>
        <span style="float:right;margin-right:10px"><a href="https://www.snapraid.it/manual" target="_blank" title="SnapRAID User Manual"><i class="fa fa-file-text-o"></i> User Manual</a> / <a href="https://www.snapraid.it/faq" target="_blank" title="SnapRAID FAQ"><i class="fa fa-question-circle-o"></i> Frequently Asked Questions</a></span>
        
        <br><strong>Advanced Parameters:</strong>
        <input type="checkbox" id="snapcheck-auditonly" value="snapcheck-auditonly">
        <label for="snapcheck-auditonly" title="In CHECK verifies the hash of the files without doing any kind of check on the parity data. If you are interested in checking only the file data this option can speed up a lot the checking process." class="snaphelptip">(Check) Audit Only</label>
        <input type="checkbox" id="snapsync-forcefull" value="snapsync-forcefull">
        <label for="snapsync-forcefull" title="In SYNC forces a full recomputation of the parity. This option can be used when you add a new parity level, or if you reverted back to an old content file using a more recent parity data. Instead of recreating the parity from scratch, this allows to reuse the hashes present in the content file to validate data, and to maintain data protection during the SYNC process using the parity data you have." class="snaphelptip">(Sync) Force Full</label>
        <input type="checkbox" id="snapsync-forcezero" value="snapsync-forcezero">
        <label for="snapsync-forcezero" title="Forces the insecure operation of syncing a file with zero size that before was not. If SnapRAID detects a such condition, it stops proceeding unless you specify this option." class="snaphelptip">(Sync) Force Zero</label>
        <input type="checkbox" id="snapsync-forceempty" value="snapsync-forceempty">
        <label for="snapsync-forceempty" title="Forces the insecure operation of syncing a disk with all the files missing. If SnapRAID detects that all the files originally present in the disk are missing or rewritten, it stops proceeding unless you specify this option." class="snaphelptip">(Sync) Force Empty</label>
        <span style="float:right;margin-right:10px;">Please always read and understand the manual before acting!</span>
       
        <br><strong>Scrub Selectors:</strong>
        <input type="radio" id="snapscrub-plan" name="snapscrub-opts" value="snapscrub-plan">
        (Scrub) <input type="text" id="snapscrub-age" class="snaphelptip" style="margin-right:0px;width:60px;" title="Scrub blocks not scrubbed for (x) days." placeholder="days">
        (Scrub) <input type="text" id="snapscrub-percent" class="snaphelptip" style="margin-right:0px;width:60px;" title="Scrub (x) percent of the array." placeholder="percent">
        <input type="radio" id="snapscrub-new" name="snapscrub-opts" value="snapscrub-new">
        <span title="Scrub only blocks not yet scrubbed." class="snaphelptip">(Scrub) New Blocks</span>
        <input type="radio" id="snapscrub-bad" name="snapscrub-opts"  value="snapscrub-bad">
        <span title="Scrub only blocks previously marked as bad." class="snaphelptip">(Scrub) Bad Blocks</span>
        <input type="radio" id="snapscrub-full" name="snapscrub-opts" value="snapscrub-full">
        <span title="Scrub the whole array." class="snaphelptip">(Scrub) Full</span>
        <span style="float:right;margin-right:10px;">SnapRAID &copy; 2011-2024 Andrea Mazzoleni - All Rights Reserved</span>
            
        <br><strong>Screen Settings:</strong>
        <input type="radio" id="snap-verbose" name="snap-verbosity" value="snap-verbose">
        <span title="Prints more information on the screen." class="snaphelptip">Verbose</span>
        <input type="radio" id="snap-hideprogress" name="snap-verbosity" value="snap-hideprogress">
        <span title="Hides any repetitive progress output." class="snaphelptip">Hide Progress Output</span>
        <span style="margin-left:10px"><strong>Interrupt Thresholds:</strong></span>
        (Sync/Scrub) <input type="text" id="snapsync-errorlimit" class="snaphelptip" style="width:140px;" title="Sets a new error limit before stopping execution. By default SnapRAID stops if it encounters more than 100 Input/Output errors, meaning that a disk is likely dying." placeholder="I/O Error Limit">
 
        <br><strong>Data Subset Selection Filters:</strong>
        (Check/Fix) <input type="text" id="snapfix-pattern" class="snaphelptip" style="width:205px;" title="Run a command only on a certain set of data." placeholder="Path Pattern (See Manual)">
        (Check/Fix) <input type="text" id="snapfix-diskpattern" title="Run a command only on a certain disk." class="narrow snaphelptip" placeholder="Disk Name">

        <br><strong>Recovery Parameters for Experts:</strong>
        <input type="checkbox" id="snapsync-forcerealloc" value="snapsync-forcerealloc">
        <label for="snapsync-forcerealloc" title="In SYNC forces a full reallocation of files and rebuild of the parity. This option can be used to completely reallocate all the files removing the fragmentation, but reusing the hashes present in the content file to validate data. This option is for experts only, and it's highly recommended to not use it. You DO NOT have data protection during the SYNC operation." class="snaphelptip">(Sync) Force Realloc</label>
        <span style="margin-left:10px;">
        (Check/Fix) <input type="text" id="snapfix-blkstart" class="snaphelptip" style="margin-right:0px;width:110px;" title="Starts the processing from the specified block number. It could be useful to retry to check or fix some specific block, in case of a damaged disk. It's present mainly for advanced manual recovering." placeholder="Block Start">
        (Check/Fix) <input type="text" id="snapfix-blkcount" class="snaphelptip" style="margin-right:0px;width:110px;" title="Processes only the specified number of blocks. It's present mainly for advanced manual recovering." placeholder="Block Count">
        </span>

        <br><strong>Operational Safety Overrides:</strong>
        <input type="checkbox" id="snapsync-forcenocopy" value="forcenocopy">
        <label for="snapsync-forcenocopy" title="In SYNC, CHECK and FIX disables the copy detection heuristic. Without this option SnapRAID assumes that files with same attributes, like name, size and time-stamp are copies with the same data. This allows to identify copied or moved files from one disk to another, and to reuse the already computed hash information to detect silent errors or to recover missing files. This, in some rare cases, may result in false positives or in a slow process due the many hash verifications, which this option resolves." class="snaphelptip">(Sync/Check/Fix) Force No-Copy</label>
        <input type="checkbox" id="snapcheck-forceuuid" value="snapcheck-forceuuid">
        <label for="snapcheck-forceuuid" title="Forces the insecure operation of syncing, checking and fixing with disks that have changed their UUID. If SnapRAID detects that some disks have changed UUID, it stops proceeding unless you specify this option. This allows to detect when your disks are mounted in the wrong mount points. It's anyway allowed to have a single UUID change with single parity, and more with multiple parity, because it's a normal situation when replacing disks as part of a recovery." class="snaphelptip">(Sync/Check/Fix) Force UUID</label>
        <input type="checkbox" id="snapfix-forcedevice" value="snapfix-forcedevice">
        <label for="snapfix-forcedevice" title="Forces the insecure operation of fixing with inaccessible disks, or with disks on the same physical device. For example if you lost two data disks, and you have a spare disk to recover only the first one, and you want to ignore the second inaccessible disk. Alternatively if you want to recover a disk in the free space left on an already used disk, meaning on the same physical device. " class="snaphelptip">(Fix) Force Device</label>    
    </div><br>

    <div><strong>INFORMATION:</strong></div>
    <div>When using SnapRAID on top of Unraid's parity, always attempt to recover drive failures using Unraid's parity first, before using any SnapRAID recovery functions.</div>
    <div>Ideally you can restore a drive failure with Unraid and then fix any file level corruption on the recovered drive using a previous (non-corrupted) SnapRAID snapshot.</div>
    <div>A failing drive may write bogus data before Unraid disables it (if at all), and SnapRAID may fill that gap to recover from corruption using a sync state from before that.</div>
    
    <br>
    <?
        $snap_syncneeded_html = "";
        $snap_unmounted_disks_html = "";

        if(!empty($dwsnap_parity_disks) || !empty($dwsnap_data_disks)) {
            if(file_exists("/boot/config/plugins/dwsnap/config/syncneeded")) {
                $snap_syncneeded_html = "<span class='snaphelptip' style='margin-left:10px;color:red;' title='Differences between the last sync (snapshot) state and the data present in the array were found. If these changes were intentional, a SYNC operation is required for any such changes to also be protected in case of disk failure. If these changes were not intentional, a FIX operation can help revert the array data back to the last sync (snapshot) state.'><i class='fa fa-exclamation-triangle'></i> <strong>Data Differences (Not in Sync)</strong></span>";
            }

            $snap_all_disks_mounted = true;
            foreach ($dwsnap_parity_disks as $snap_parity_disk) {
                $snap_disk_fs = htmlspecialchars(shell_exec("cat /etc/mtab 2>/dev/null | grep " . $snap_parity_disk[2] . " 2>/dev/null | awk '{print $3}' 2>/dev/null") ?? "-");
                if($snap_disk_fs == "-") { $snap_all_disks_mounted = false; }
            }
            foreach ($dwsnap_data_disks as $snap_data_disk) {
                $snap_disk_fs = htmlspecialchars(shell_exec("cat /etc/mtab 2>/dev/null | grep " . $snap_data_disk[2] . " 2>/dev/null | awk '{print $3}' 2>/dev/null") ?? "-");
                if($snap_disk_fs == "-") { $snap_all_disks_mounted = false; }
            }

            if(!$snap_all_disks_mounted) {
                $snap_unmounted_disks_html = "<span class='snaphelptip' style='margin-left:10px;color:red;' title='At least one configured disk is not online and/or mounted, please check both your configuration and the actual disks for issues.'><i class='fa fa-exclamation-triangle'></i> <strong>Missing Disk(s)</strong></span>";
            }
        }
    ?>
    <table class="tablesorter snapdisks">
        <thead>
            <tr>
                <th colspan="10"><strong>ARRAY OVERVIEW WITH INDIVIDUAL DISKS</strong> <span style="text-transform: none;float:right;"><?=$snap_unmounted_disks_html?><?=$snap_syncneeded_html?><span style="margin-left:10px;"><strong>Last Sync:</strong> <?=$snap_lastsync_html?></span><span style="margin-left:10px;"><strong>Last Scrub:</strong> <?=$snap_lastscrub_html?></span></span></th>
            </tr>
            <tr>
                 <th><strong>Disk Type</strong></th><th><strong>Disk Name</strong></th><th><strong>Mountpoint</strong></th><th><strong>Mounted</strong></th><th><strong>FileSystem</strong></th><th><strong>Total Space</strong></th><th><strong>Used Space</strong></th><th><strong>Free Space</strong></th><th><strong>Utilization</strong></th><th><strong>Disk-Specific Operations</strong><br><span style="font-size:x-small;"><em>Options Selected From Above Apply</em></span></th>
            </tr>
        </thead>
        <tbody>
            <?
            if(!empty($dwsnap_parity_disks) || !empty($dwsnap_data_disks)) {
                foreach ($dwsnap_parity_disks as $snap_parity_disk){
                    $snap_disk_fs = trim(htmlspecialchars(shell_exec("cat /etc/mtab 2>/dev/null | grep " . $snap_parity_disk[2] . " 2>/dev/null | awk '{print $3}' 2>/dev/null") ?? "-"));
                    $snap_disk_util = trim(htmlspecialchars(shell_exec("df -h 2>/dev/null | grep " . $snap_parity_disk[2] . " 2>/dev/null | awk '{print $5}' 2>/dev/null") ?? "-"));
                    $snap_disk_free = trim(htmlspecialchars(shell_exec("df -h 2>/dev/null | grep " . $snap_parity_disk[2] . " 2>/dev/null | awk '{print $4}' 2>/dev/null") ?? "-"));
                    $snap_disk_used = trim(htmlspecialchars(shell_exec("df -h 2>/dev/null | grep " . $snap_parity_disk[2] . " 2>/dev/null | awk '{print $3}' 2>/dev/null") ?? "-"));
                    $snap_disk_total = trim(htmlspecialchars(shell_exec("df -h 2>/dev/null | grep " . $snap_parity_disk[2] . " 2>/dev/null | awk '{print $2}' 2>/dev/null") ?? "-"));
                    $snap_disk_status = ($snap_disk_fs !== "-") ? "<i class='fa fa-check green-text'></i>" : "<i class='fa fa-times red-text'></i>"; 
                    $snap_parity_level = strtoupper($snap_parity_disk[1]);
                    echo <<<END
                    <tr>
                    <td class="snapdisktype">$snap_parity_level</td>
                    <td>$snap_parity_disk[1]</td>
                    <td>
                        <a class="view" href="/Shares/Browse?dir=$snap_parity_disk[2]/" target="_blank">
                        <i class="icon-u-tab" title="Browse $snap_parity_disk[2]/"></i>
                        </a>$snap_parity_disk[2]
                    </td>
                    <td>$snap_disk_status</td>
                    <td>$snap_disk_fs</td>
                    <td>$snap_disk_total</td>
                    <td>$snap_disk_used</td>
                    <td>$snap_disk_free</td>
                    <td>$snap_disk_util</td>
                    <td>
                        <input type="button" class="snaprun snaphelptip" id="$snap_parity_disk[1]-check" value="Check" title="Verify all the files and the parity data. It works like FIX, but it only simulates a recovery and no changes are written. This command only processes the selected disk.">
                        <input type="button" class="snaprun snaphelptip" id="$snap_parity_disk[1]-fix" value="Fix" title="Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it is reverted to the stored snapshot. The FIX command does not differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC. This command only processes the selected disk.">
                        <input type="button" class="snaprun snaphelptip" id="$snap_parity_disk[1]-fixmissing" value="Fix Missing" title="Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it is reverted to the stored snapshot. The FIX command does not differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC. Only processes missing or deleted files on the selected disk.">
                    </td>
                    </tr>
END;
                }
                foreach ($dwsnap_data_disks as $snap_data_disk){
                    $snap_disk_fs = trim(htmlspecialchars(shell_exec("cat /etc/mtab 2>/dev/null | grep " . $snap_data_disk[2] . " 2>/dev/null | awk '{print $3}' 2>/dev/null") ?? "-"));
                    $snap_disk_util = trim(htmlspecialchars(shell_exec("df -h 2>/dev/null | grep " . $snap_data_disk[2] . " 2>/dev/null | awk '{print $5}' 2>/dev/null") ?? "-"));
                    $snap_disk_free = trim(htmlspecialchars(shell_exec("df -h 2>/dev/null | grep " . $snap_data_disk[2] . " 2>/dev/null | awk '{print $4}' 2>/dev/null") ?? "-"));
                    $snap_disk_used = trim(htmlspecialchars(shell_exec("df -h 2>/dev/null | grep " . $snap_data_disk[2] . " 2>/dev/null | awk '{print $3}' 2>/dev/null") ?? "-"));
                    $snap_disk_total = trim(htmlspecialchars(shell_exec("df -h 2>/dev/null | grep " . $snap_data_disk[2] . " 2>/dev/null | awk '{print $2}' 2>/dev/null") ?? "-"));
                    $snap_disk_status = ($snap_disk_fs !== "-") ? "<i class='fa fa-check green-text'></i>" : "<i class='fa fa-times red-text'></i>"; 
                    echo <<<END
                    <tr>
                    <td class="snapdisktype">DATA</td>
                    <td>$snap_data_disk[1]</td>
                    <td>
                        <a class="view" href="/Shares/Browse?dir=$snap_data_disk[2]/" target="_blank">
                        <i class="icon-u-tab" title="Browse $snap_data_disk[2]/"></i>
                        </a>$snap_data_disk[2]
                    </td>
                    <td>$snap_disk_status</td>
                    <td>$snap_disk_fs</td>
                    <td>$snap_disk_total</td>
                    <td>$snap_disk_used</td>
                    <td>$snap_disk_free</td>
                    <td>$snap_disk_util</td>
                    <td>
                        <input type="button" class="snaprun snaphelptip" id="$snap_data_disk[1]-check" value="Check" title="Verify all the files and the parity data. It works like FIX, but it only simulates a recovery and no changes are written. This command only processes the selected disk.">
                        <input type="button" class="snaprun snaphelptip" id="$snap_data_disk[1]-fix" value="Fix" title="Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it is reverted to the stored snapshot. The FIX command does not differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC. This command only processes the selected disk.">
                        <input type="button" class="snaprun snaphelptip" id="$snap_data_disk[1]-fixmissing" value="Fix Missing" title="Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it is reverted to the stored snapshot. The FIX command does not differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC. Only processes missing or deleted files on the selected disk.">
                    </td>
                    </tr>
END;
                }
            }
            else {
                echo("<tr><td colspan='10'><em>There are no disks configured</em></td></tr>");
            }
            ?>
        </tbody>
    </table>
</form> 

<script type="text/javascript">
function getSnapLogs() {
    $.get('/plugins/dwsnap/include/dwsnap_logger.php',function(data) {
        if (data) { 
            $('#logviewer').html(data); 
	        var pre = $(".snaplog");
	        pre.scrollTop(pre.prop("scrollHeight"));
	    }
    });
    clearTimeout(timers.getSnapLogs);
    timers.getSnapLogs = setTimeout(getSnapLogs, 1000);
}
function getSnapStatus() {
    $.get('/plugins/dwsnap/include/dwsnap_status.php',function(data) {
        if (data) { 
            if(data === "RUNNING:YES") {
                $('#snapstatusicon').show();
                $('.snaprun').prop('disabled', true);
                $('.snapnotrun').prop('disabled', false);
            } else if (data === "RUNNING:NO") {
                if($('#snapstatusicon').is(":visible")) {
                    location = '/Settings/dwsnapOps';
                }
                $('#snapstatusicon').hide();
                $('.snaprun').prop('disabled', false);
                $('.snapnotrun').prop('disabled', true);
                $('#logcontrol').attr("class", "fa fa-refresh");
                clearTimeout(timers.getSnapLogs);
            }
	    }
    });
    clearTimeout(timers.getSnapStatus);
    timers.getSnapStatus = setTimeout(getSnapStatus, 3000);
}
function toggleSnapLogs() {
    if($('#logcontrol').attr("class") == "fa fa-refresh fa-spin") {
        $('#logcontrol').attr("class", "fa fa-refresh");
        clearTimeout(timers.getSnapLogs);
    } else {
        $('#logcontrol').attr("class", "fa fa-refresh fa-spin");
        getSnapLogs();
    }
}
function confirmCommandAndSubmit() {
    var snapCmd = "snapraid ";
    $('[id^="arg"]:not(:first)').each(function() {
        if($(this).val()) {
            snapCmd += $(this).val() + " ";
        }
    });
    swal({
        title: "Operation Command",
        text: "Are you absolutely certain that this is the operation you want to run?<br>Please refer to the <a href='https://www.snapraid.it/manual' target='_blank'>SnapRAID manual</a> again if you are not 100% sure.<br><pre>" + snapCmd + "</pre>Be advised there will be no more confirmations after this message.",
        type: "warning",
        showCancelButton: true,
        confirmButtonText: "Start Operation",
        html: true
        },
        function(isConfirmed){
            if(isConfirmed) {
                $('#snapcommands').submit();
            } else {
                $('#command').val(""); 
                $('[id^="arg"]').each(function() {
                    $(this).val("");
                });
            }
        });
}
$(function(){
    $('#logcontrol').click(toggleSnapLogs);

    $('#snapstatus').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
        if($('#snap-notifyme').is(':checked')) {
            $('#arg1').val('1');
        } else {
            $('#arg1').val('0');
        }
        $('#arg2').val('status');
        $('#snapcommands').submit();
    });
    $('#snaplist').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
        if($('#snap-notifyme').is(':checked')) {
            $('#arg1').val('1');
        } else {
            $('#arg1').val('0');
        }
        $('#arg2').val('list');
        $('#snapcommands').submit();
    });
    $('#snapdiff').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
        if($('#snap-notifyme').is(':checked')) {
            $('#arg1').val('1');
        } else {
            $('#arg1').val('0');
        }
        $('#arg2').val('diff');
        if($('#snapcheck-forceuuid').is(':checked')) {
            $('#arg3').val('-U');
        }
        $('#snapcommands').submit();
    });
    $('#snapdup').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
        if($('#snap-notifyme').is(':checked')) {
            $('#arg1').val('1');
        } else {
            $('#arg1').val('0');
        }
        $('#arg2').val('dup');
        $('#snapcommands').submit();
    });
    $('#snapscrub').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
        if($('#snap-notifyme').is(':checked')) {
            $('#arg1').val('1');
        } else {
            $('#arg1').val('0');
        }
        $('#arg2').val('scrub');
        if($('#snapscrub-bad').is(':checked')) {
            $('#arg3').val('-p');
            $('#arg4').val('bad');
        }
        else if($('#snapscrub-new').is(':checked')) {
            $('#arg3').val('-p');
            $('#arg4').val('new');
        }
        else if($('#snapscrub-full').is(':checked')) {
            $('#arg3').val('-p');
            $('#arg4').val('full');
        }
        else if($('#snapscrub-plan').is(':checked')) {
           if($('#snapscrub-percent').val()) {
                $('#arg3').val('-p');
                $('#arg4').val($('#snapscrub-percent').val());
            }
            if($('#snapscrub-age').val()) {
                $('#arg5').val('-o');
                $('#arg6').val($('#snapscrub-age').val());
            }
        }
        if($('#snapsync-errorlimit').val()) {
            $('#arg7').val('-L');
            $('#arg8').val($('#snapsync-errorlimit').val());
        }
        if($('#snap-hideprogress').is(':checked')) {
            $('#arg9').val('-q');
        } else if ($('#snap-verbose').is(':checked')) {
            $('#arg9').val('-v');
        }
        confirmCommandAndSubmit();
    });
    $('#snapcheck').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
        if($('#snap-notifyme').is(':checked')) {
            $('#arg1').val('1');
        } else {
            $('#arg1').val('0');
        }
        $('#arg2').val('check');
        if($('#snapcheck-auditonly').is(':checked')) {
            $('#arg3').val('-a');
        }
        if($('#snapfix-diskpattern').val()) {
            $('#arg4').val('-d');
            $('#arg5').val($('#snapfix-diskpattern').val());
        }
        if($('#snapfix-pattern').val()) {
            $('#arg6').val('-f');
            $('#arg7').val($('#snapfix-pattern').val());
        }
        if($('#snapcheck-forceuuid').is(':checked')) {
            $('#arg8').val('-U');
        }
        if($('#snapsync-forcenocopy').is(':checked')) {
            $('#arg9').val('-N');
        }
        if($('#snapfix-blkstart').val()) {
            $('#arg10').val('-S');
            $('#arg11').val($('#snapfix-blkstart').val());
        }
        if($('#snapfix-blkcount').val()) {
            $('#arg12').val('-B');
            $('#arg13').val($('#snapfix-blkcount').val());
        }
        if($('#snap-hideprogress').is(':checked')) {
            $('#arg14').val('-q');
        } else if ($('#snap-verbose').is(':checked')) {
            $('#arg14').val('-v');
        }
        confirmCommandAndSubmit();
    });

    $('#clearoutput').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/clearoutput');
        $('#snapcommands').submit();
    });
    $('#clearlogs').click(function(){
        swal({
            title: "Are you sure?",
            text: "This action will delete any stored SnapRAID logfiles.",
            type: "warning",
            showCancelButton: true,
            confirmButtonText: "Clear All Logs",
            html: true
            },
            function(){
                $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/clearlogs');
                $('#snapcommands').submit();
            });
    });
    $('#snapstop').click(function(){
        swal({
            title: "Are you sure?",
            text: "This action will (gracefully) stop all running SnapRAID instances.",
            type: "warning",
            showCancelButton: true,
            confirmButtonText: "Stop Operation",
            html: true
            },
            function(){
                $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/stop');
                $('#snapcommands').submit();
            });
    });
    $('#snapkill').click(function(){
        swal({
            title: "Destructive Operation",
            text: "This action will kill all running SnapRAID instances.<br>Be advised <u>data corruption</u> can be a result of this action.",
            type: "error",
            showCancelButton: true,
            confirmButtonText: "Kill Operation",
            html: true
            },
            function(){
                $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/kill');
                $('#snapcommands').submit();
            });
    });

    $('#snapsync').click(function(){
        swal({
            title: "Destructive Operation",
            text: "This is a <u>potentially destructive</u> array operation. That means it will change either your parity, your protected files or both. Please make sure you consulted the <a href='https://www.snapraid.it/manual' target='_blank'>SnapRAID manual</a> and <u>fully understand what you are about to do</u> before proceeding with this operation.<br><br>Updates the parity information. All the modified files in the disk array are read, and the corresponding parity data is updated.<br><br>Takes a snapshot, the base for all recoveries.",
            type: "warning",
            showCancelButton: true,
            confirmButtonText: "Start Operation",
            closeOnConfirm: false,
            html: true
            },
            function(){
                $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                if($('#snap-notifyme').is(':checked')) {
                    $('#arg1').val('1');
                } else {
                    $('#arg1').val('0');
                }
                $('#arg2').val('sync');
                if($('#snapsync-forcezero').is(':checked')) {
                    $('#arg3').val('-Z');
                }
                if($('#snapsync-forceempty').is(':checked')) {
                    $('#arg4').val('-E');
                }
                if($('#snapsync-forcefull').is(':checked')) {
                    $('#arg5').val('-F');
                }
                if($('#snapsync-forcerealloc').is(':checked')) {
                    $('#arg6').val('-R');
                }
                if($('#snapcheck-forceuuid').is(':checked')) {
                    $('#arg7').val('-U');
                }
                if($('#snapsync-forcenocopy').is(':checked')) {
                    $('#arg8').val('-N');
                }
                if($('#snapsync-errorlimit').val()) {
                    $('#arg9').val('-L');
                    $('#arg10').val($('#snapsync-errorlimit').val());
                }
                if($('#snap-hideprogress').is(':checked')) {
                    $('#arg11').val('-q');
                } else if ($('#snap-verbose').is(':checked')) {
                    $('#arg11').val('-v');
                }
                confirmCommandAndSubmit();
            });
    });  
    $('#snaphashedsync').click(function(){
        swal({
            title: "Destructive Operation",
            text: "This is a <u>potentially destructive</u> array operation. That means it will change either your parity, your protected files or both. Please make sure you consulted the <a href='https://www.snapraid.it/manual' target='_blank'>SnapRAID manual</a> and <u>fully understand what you are about to do</u> before proceeding with this operation.<br><br>Updates the parity information. All the modified files in the disk array are read, and the corresponding parity data is updated.<br><br>Takes a snapshot, the base for all recoveries.<br><br>A preliminary hashing phase of all the new data, to have an additional verification before the actual parity computation, is performed.",
            type: "warning",
            showCancelButton: true,
            confirmButtonText: "Start Operation",
            closeOnConfirm: false,
            html: true
            },
            function(){
                $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                if($('#snap-notifyme').is(':checked')) {
                    $('#arg1').val('1');
                } else {
                    $('#arg1').val('0');
                }
                $('#arg2').val('sync');
                $('#arg3').val('-h');
                if($('#snapsync-forcezero').is(':checked')) {
                    $('#arg4').val('-Z');
                }
                if($('#snapsync-forceempty').is(':checked')) {
                    $('#arg5').val('-E');
                }
                if($('#snapsync-forcefull').is(':checked')) {
                    $('#arg6').val('-F');
                }
                if($('#snapsync-forcerealloc').is(':checked')) {
                    $('#arg7').val('-R');
                }
                if($('#snapcheck-forceuuid').is(':checked')) {
                    $('#arg8').val('-U');
                }
                if($('#snapsync-forcenocopy').is(':checked')) {
                    $('#arg9').val('-N');
                }
                if($('#snapsync-errorlimit').val()) {
                    $('#arg10').val('-L');
                    $('#arg11').val($('#snapsync-errorlimit').val());
                }
                if($('#snap-hideprogress').is(':checked')) {
                    $('#arg12').val('-q');
                } else if ($('#snap-verbose').is(':checked')) {
                    $('#arg12').val('-v');
                }
                confirmCommandAndSubmit();
            });
    });
    $('#snaptouch').click(function(){
        swal({
            title: "Destructive Operation",
            text: "This is a <u>potentially destructive</u> array operation. That means it will change either your parity, your protected files or both. Please make sure you consulted the <a href='https://www.snapraid.it/manual' target='_blank'>SnapRAID manual</a> and <u>fully understand what you are about to do</u> before proceeding with this operation.<br><br>Sets arbitrarily the sub-second time-stamp of all the files that have it at zero. This improves the SnapRAID capability to recognize moved and copied files as it makes the time-stamp almost unique.",
            type: "warning",
            showCancelButton: true,
            confirmButtonText: "Start Operation",
            closeOnConfirm: false,
            html: true
            },
            function(){
                $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                if($('#snap-notifyme').is(':checked')) {
                    $('#arg1').val('1');
                } else {
                    $('#arg1').val('0');
                }
                $('#arg2').val('touch');
                confirmCommandAndSubmit();
            });
    });
    $('#snapfix').click(function(){
        swal({
            title: "Destructive Operation",
            text: "This is a <u>potentially destructive</u> array operation. That means it will change either your parity, your protected files or both. Please make sure you consulted the <a href='https://www.snapraid.it/manual' target='_blank'>SnapRAID manual</a> and <u>fully understand what you are about to do</u> before proceeding with this operation.<br><br>Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it's reverted to the stored snapshot. This command doesn't differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC.<br><br>If no other option is specified the full array is processed. Use the filter options to select a subset of files or disks to operate on.",
            type: "warning",
            showCancelButton: true,
            confirmButtonText: "Start Operation",
            closeOnConfirm: false,
            html: true
            },
            function(){
                $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                if($('#snap-notifyme').is(':checked')) {
                    $('#arg1').val('1');
                } else {
                    $('#arg1').val('0');
                }
                $('#arg2').val('fix');
                if($('#snapfix-diskpattern').val()) {
                    $('#arg3').val('-d');
                    $('#arg4').val($('#snapfix-diskpattern').val());
                }
                if($('#snapfix-pattern').val()) {
                    $('#arg5').val('-f');
                    $('#arg6').val($('#snapfix-pattern').val());
                }
                if($('#snapcheck-forceuuid').is(':checked')) {
                    $('#arg7').val('-U');
                }
                if($('#snapfix-forcedevice').is(':checked')) {
                    $('#arg8').val('-D');
                }
                if($('#snapsync-forcenocopy').is(':checked')) {
                    $('#arg9').val('-N');
                }
                if($('#snapfix-blkstart').val()) {
                    $('#arg10').val('-S');
                    $('#arg11').val($('#snapfix-blkstart').val());
                }
                if($('#snapfix-blkcount').val()) {
                    $('#arg12').val('-B');
                    $('#arg13').val($('#snapfix-blkcount').val());
                }
                if($('#snap-hideprogress').is(':checked')) {
                    $('#arg14').val('-q');
                } else if ($('#snap-verbose').is(':checked')) {
                    $('#arg14').val('-v');
                }
                confirmCommandAndSubmit();
            });
    });
    $('#snapfixmissing').click(function(){
        swal({
            title: "Destructive Operation",
            text: "This is a <u>potentially destructive</u> array operation. That means it will change either your parity, your protected files or both. Please make sure you consulted the <a href='https://www.snapraid.it/manual' target='_blank'>SnapRAID manual</a> and <u>fully understand what you are about to do</u> before proceeding with this operation.<br><br>Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it's reverted to the stored snapshot.<br><br>Only all files missing/deleted from the array are processed.",
            type: "warning",
            showCancelButton: true,
            confirmButtonText: "Start Operation",
            closeOnConfirm: false,
            html: true
            },
            function(){
                $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                if($('#snap-notifyme').is(':checked')) {
                    $('#arg1').val('1');
                } else {
                    $('#arg1').val('0');
                }
                $('#arg2').val('fix');
                $('#arg3').val('-m');
                if($('#snapfix-diskpattern').val()) {
                    $('#arg4').val('-d');
                    $('#arg5').val($('#snapfix-diskpattern').val());
                }
                if($('#snapfix-pattern').val()) {
                    $('#arg6').val('-f');
                    $('#arg7').val($('#snapfix-pattern').val());
                }
                if($('#snapcheck-forceuuid').is(':checked')) {
                    $('#arg8').val('-U');
                }
                if($('#snapfix-forcedevice').is(':checked')) {
                    $('#arg9').val('-D');
                }
                if($('#snapsync-forcenocopy').is(':checked')) {
                    $('#arg10').val('-N');
                }
                if($('#snapfix-blkstart').val()) {
                    $('#arg11').val('-S');
                    $('#arg12').val($('#snapfix-blkstart').val());
                }
                if($('#snapfix-blkcount').val()) {
                    $('#arg13').val('-B');
                    $('#arg14').val($('#snapfix-blkcount').val());
                }
                if($('#snap-hideprogress').is(':checked')) {
                    $('#arg15').val('-q');
                } else if ($('#snap-verbose').is(':checked')) {
                    $('#arg15').val('-v');
                }
                confirmCommandAndSubmit();
            });
    });
    $('#snapfixerrors').click(function(){
        swal({
            title: "Destructive Operation",
            text: "This is a <u>potentially destructive</u> array operation. That means it will change either your parity, your protected files or both. Please make sure you consulted the <a href='https://www.snapraid.it/manual' target='_blank'>SnapRAID manual</a> and <u>fully understand what you are about to do</u> before proceeding with this operation.<br><br>Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it's reverted to the stored snapshot.<br><br>Only files that have blocks marked with silent or input/output errors during previous SYNC and SCRUB operations are processed.",
            type: "warning",
            showCancelButton: true,
            confirmButtonText: "Start Operation",
            closeOnConfirm: false,
            html: true
            },
            function(){
                $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                if($('#snap-notifyme').is(':checked')) {
                    $('#arg1').val('1');
                } else {
                    $('#arg1').val('0');
                }
                $('#arg2').val('fix');
                $('#arg3').val('-e');
                if($('#snapfix-diskpattern').val()) {
                    $('#arg4').val('-d');
                    $('#arg5').val($('#snapfix-diskpattern').val());
                }
                if($('#snapfix-pattern').val()) {
                    $('#arg6').val('-f');
                    $('#arg7').val($('#snapfix-pattern').val());
                }
                if($('#snapcheck-forceuuid').is(':checked')) {
                    $('#arg8').val('-U');
                }
                if($('#snapfix-forcedevice').is(':checked')) {
                    $('#arg9').val('-D');
                }
                if($('#snapsync-forcenocopy').is(':checked')) {
                    $('#arg10').val('-N');
                }
                if($('#snapfix-blkstart').val()) {
                    $('#arg11').val('-S');
                    $('#arg12').val($('#snapfix-blkstart').val());
                }
                if($('#snapfix-blkcount').val()) {
                    $('#arg13').val('-B');
                    $('#arg14').val($('#snapfix-blkcount').val());
                }
                if($('#snap-hideprogress').is(':checked')) {
                    $('#arg15').val('-q');
                } else if ($('#snap-verbose').is(':checked')) {
                    $('#arg15').val('-v');
                }
                confirmCommandAndSubmit();
            });
    });
    $('#crontest').click(function(){
        swal({
            title: "Are you sure?",
            text: "This action is <u>not simulated</u>, it will really run (as configured).",
            type: "warning",
            showCancelButton: true,
            confirmButtonText: "Start Operation",
            html: true
            },
            function(){
                $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/crontest');
                $('#snapcommands').submit();
            });
    });

    <?
    if(!empty($dwsnap_parity_disks) || !empty($dwsnap_data_disks)) {
        foreach ($dwsnap_parity_disks as $snap_parity_disk) {
            echo <<<END
            \$('#$snap_parity_disk[1]-check').click(function() {
                \$('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                if(\$('#snap-notifyme').is(':checked')) {
                    \$('#arg1').val('1');
                } else {
                    \$('#arg1').val('0');
                }
                \$('#arg2').val('check');
                \$('#arg3').val('-d');
                \$('#arg4').val('$snap_parity_disk[1]');
                if (\$('#snapcheck-auditonly').is(':checked')) {
                    \$('#arg5').val('-a');
                }
                if (\$('#snapfix-pattern').val()) {
                    \$('#arg6').val('-f');
                    \$('#arg7').val(\$('#snapfix-pattern').val());
                }
                if (\$('#snapcheck-forceuuid').is(':checked')) {
                    \$('#arg8').val('-U');
                }
                if (\$('#snapsync-forcenocopy').is(':checked')) {
                    \$('#arg9').val('-N');
                }
                if (\$('#snapfix-blkstart').val()) {
                    \$('#arg10').val('-S');
                    \$('#arg11').val(\$('#snapfix-blkstart').val());
                }
                if (\$('#snapfix-blkcount').val()) {
                    \$('#arg12').val('-B');
                    \$('#arg13').val(\$('#snapfix-blkcount').val());
                }
                if (\$('#snap-hideprogress').is(':checked')) {
                    \$('#arg14').val('-q');
                } else if (\$('#snap-verbose').is(':checked')) {
                    \$('#arg14').val('-v');
                }
                confirmCommandAndSubmit();
            });
            \$('#$snap_parity_disk[1]-fix').click(function() {
                swal({
                    title: "Destructive Operation",
                    text: "This is a <u>potentially destructive</u> array operation. That means it will change either your parity, your protected files or both. Please make sure you consulted the <a href='https://www.snapraid.it/manual' target='_blank'>SnapRAID manual</a> and <u>fully understand what you are about to do</u> before proceeding with this operation.<br><br>Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it's reverted to the stored snapshot. This command doesn't differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC.<br><br>This command only processes the selected disk.",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Start Operation",
                    closeOnConfirm: false,
                    html: true
                }, function() {
                    \$('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                    if(\$('#snap-notifyme').is(':checked')) {
                        \$('#arg1').val('1');
                    } else {
                        \$('#arg1').val('0');
                    }
                    \$('#arg2').val('fix');
                    \$('#arg3').val('-d');
                    \$('#arg4').val('$snap_parity_disk[1]');
                    if (\$('#snapfix-pattern').val()) {
                        \$('#arg5').val('-f');
                        \$('#arg6').val(\$('#snapfix-pattern').val());
                    }
                    if (\$('#snapcheck-forceuuid').is(':checked')) {
                        \$('#arg7').val('-U');
                    }
                    if (\$('#snapfix-forcedevice').is(':checked')) {
                        \$('#arg8').val('-D');
                    }
                    if (\$('#snapsync-forcenocopy').is(':checked')) {
                        \$('#arg9').val('-N');
                    }
                    if (\$('#snapfix-blkstart').val()) {
                        \$('#arg10').val('-S');
                        \$('#arg11').val(\$('#snapfix-blkstart').val());
                    }
                    if (\$('#snapfix-blkcount').val()) {
                        \$('#arg12').val('-B');
                        \$('#arg13').val(\$('#snapfix-blkcount').val());
                    }
                    if (\$('#snap-hideprogress').is(':checked')) {
                        \$('#arg14').val('-q');
                    } else if (\$('#snap-verbose').is(':checked')) {
                        \$('#arg14').val('-v');
                    }
                    confirmCommandAndSubmit();
                });
            });
            \$('#$snap_parity_disk[1]-fixmissing').click(function() {
                swal({
                    title: "Destructive Operation",
                    text: "This is a <u>potentially destructive</u> array operation. That means it will change either your parity, your protected files or both. Please make sure you consulted the <a href='https://www.snapraid.it/manual' target='_blank'>SnapRAID manual</a> and <u>fully understand what you are about to do</u> before proceeding with this operation.<br><br>Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it's reverted to the stored snapshot. This command doesn't differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC.<br><br>Only processes missing or deleted files on the selected disk.",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Start Operation",
                    closeOnConfirm: false,
                    html: true
                }, function() {
                    \$('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                    if(\$('#snap-notifyme').is(':checked')) {
                        \$('#arg1').val('1');
                    } else {
                        \$('#arg1').val('0');
                    }
                    \$('#arg2').val('fix');
                    \$('#arg3').val('-m');
                    \$('#arg4').val('-d');
                    \$('#arg5').val('$snap_parity_disk[1]');
                    if (\$('#snapfix-pattern').val()) {
                        \$('#arg6').val('-f');
                        \$('#arg7').val(\$('#snapfix-pattern').val());
                    }
                    if (\$('#snapcheck-forceuuid').is(':checked')) {
                        \$('#arg8').val('-U');
                    }
                    if (\$('#snapfix-forcedevice').is(':checked')) {
                        \$('#arg9').val('-D');
                    }
                    if (\$('#snapsync-forcenocopy').is(':checked')) {
                        \$('#arg10').val('-N');
                    }
                    if (\$('#snapfix-blkstart').val()) {
                        \$('#arg11').val('-S');
                        \$('#arg12').val(\$('#snapfix-blkstart').val());
                    }
                    if (\$('#snapfix-blkcount').val()) {
                        \$('#arg13').val('-B');
                        \$('#arg14').val(\$('#snapfix-blkcount').val());
                    }
                    if (\$('#snap-hideprogress').is(':checked')) {
                        \$('#arg15').val('-q');
                    } else if (\$('#snap-verbose').is(':checked')) {
                        \$('#arg15').val('-v');
                    }
                    confirmCommandAndSubmit();
                });
            });
END;
        }
        foreach ($dwsnap_data_disks as $snap_data_disk) {
            echo <<<END
            \$('#$snap_data_disk[1]-check').click(function() {
                \$('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                if(\$('#snap-notifyme').is(':checked')) {
                    \$('#arg1').val('1');
                } else {
                    \$('#arg1').val('0');
                }
                \$('#arg2').val('check');
                \$('#arg3').val('-d');
                \$('#arg4').val('$snap_data_disk[1]');
                if (\$('#snapcheck-auditonly').is(':checked')) {
                    \$('#arg5').val('-a');
                }
                if (\$('#snapfix-pattern').val()) {
                    \$('#arg6').val('-f');
                    \$('#arg7').val(\$('#snapfix-pattern').val());
                }
                if (\$('#snapcheck-forceuuid').is(':checked')) {
                    \$('#arg8').val('-U');
                }
                if (\$('#snapsync-forcenocopy').is(':checked')) {
                    \$('#arg9').val('-N');
                }
                if (\$('#snapfix-blkstart').val()) {
                    \$('#arg10').val('-S');
                    \$('#arg11').val(\$('#snapfix-blkstart').val());
                }
                if (\$('#snapfix-blkcount').val()) {
                    \$('#arg12').val('-B');
                    \$('#arg13').val(\$('#snapfix-blkcount').val());
                }
                if (\$('#snap-hideprogress').is(':checked')) {
                    \$('#arg14').val('-q');
                } else if (\$('#snap-verbose').is(':checked')) {
                    \$('#arg14').val('-v');
                }
                confirmCommandAndSubmit();
            });
            \$('#$snap_data_disk[1]-fix').click(function() {
                swal({
                    title: "Destructive Operation",
                    text: "This is a <u>potentially destructive</u> array operation. That means it will change either your parity, your protected files or both. Please make sure you consulted the <a href='https://www.snapraid.it/manual' target='_blank'>SnapRAID manual</a> and <u>fully understand what you are about to do</u> before proceeding with this operation.<br><br>Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it's reverted to the stored snapshot. This command doesn't differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC.<br><br>This command only processes the selected disk.",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Start Operation",
                    closeOnConfirm: false,
                    html: true
                }, function() {
                    \$('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                    if(\$('#snap-notifyme').is(':checked')) {
                        \$('#arg1').val('1');
                    } else {
                        \$('#arg1').val('0');
                    }
                    \$('#arg2').val('fix');
                    \$('#arg3').val('-d');
                    \$('#arg4').val('$snap_data_disk[1]');
                    if (\$('#snapfix-pattern').val()) {
                        \$('#arg5').val('-f');
                        \$('#arg6').val(\$('#snapfix-pattern').val());
                    }
                    if (\$('#snapcheck-forceuuid').is(':checked')) {
                        \$('#arg7').val('-U');
                    }
                    if (\$('#snapfix-forcedevice').is(':checked')) {
                        \$('#arg8').val('-D');
                    }
                    if (\$('#snapsync-forcenocopy').is(':checked')) {
                        \$('#arg9').val('-N');
                    }
                    if (\$('#snapfix-blkstart').val()) {
                        \$('#arg10').val('-S');
                        \$('#arg11').val(\$('#snapfix-blkstart').val());
                    }
                    if (\$('#snapfix-blkcount').val()) {
                        \$('#arg12').val('-B');
                        \$('#arg13').val(\$('#snapfix-blkcount').val());
                    }
                    if (\$('#snap-hideprogress').is(':checked')) {
                        \$('#arg14').val('-q');
                    } else if (\$('#snap-verbose').is(':checked')) {
                        \$('#arg14').val('-v');
                    }
                    confirmCommandAndSubmit();
                });
            });
            \$('#$snap_data_disk[1]-fixmissing').click(function() {
                swal({
                    title: "Destructive Operation",
                    text: "This is a <u>potentially destructive</u> array operation. That means it will change either your parity, your protected files or both. Please make sure you consulted the <a href='https://www.snapraid.it/manual' target='_blank'>SnapRAID manual</a> and <u>fully understand what you are about to do</u> before proceeding with this operation.<br><br>Fix all the files and the parity data. All the files and the parity data are compared with the snapshot state saved in the last SYNC. If a difference is found, it's reverted to the stored snapshot. This command doesn't differentiate between errors and intentional modifications. It unconditionally reverts the file state to the last SYNC.<br><br>Only processes missing or deleted files on the selected disk.",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Start Operation",
                    closeOnConfirm: false,
                    html: true
                }, function() {
                    \$('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/start');
                    if(\$('#snap-notifyme').is(':checked')) {
                        \$('#arg1').val('1');
                    } else {
                        \$('#arg1').val('0');
                    }
                    \$('#arg2').val('fix');
                    \$('#arg3').val('-m');
                    \$('#arg4').val('-d');
                    \$('#arg5').val('$snap_data_disk[1]');
                    if (\$('#snapfix-pattern').val()) {
                        \$('#arg6').val('-f');
                        \$('#arg7').val(\$('#snapfix-pattern').val());
                    }
                    if (\$('#snapcheck-forceuuid').is(':checked')) {
                        \$('#arg8').val('-U');
                    }
                    if (\$('#snapfix-forcedevice').is(':checked')) {
                        \$('#arg9').val('-D');
                    }
                    if (\$('#snapsync-forcenocopy').is(':checked')) {
                        \$('#arg10').val('-N');
                    }
                    if (\$('#snapfix-blkstart').val()) {
                        \$('#arg11').val('-S');
                        \$('#arg12').val(\$('#snapfix-blkstart').val());
                    }
                    if (\$('#snapfix-blkcount').val()) {
                        \$('#arg13').val('-B');
                        \$('#arg14').val(\$('#snapfix-blkcount').val());
                    }
                    if (\$('#snap-hideprogress').is(':checked')) {
                        \$('#arg15').val('-q');
                    } else if (\$('#snap-verbose').is(':checked')) {
                        \$('#arg15').val('-v');
                    }
                    confirmCommandAndSubmit();
                });
            });
END;
        }
    }
    ?>

    getSnapStatus()
    getSnapLogs();
    
    $('.snaphelptip').tooltipster({
        maxWidth: 300
    });

    if ($.cookie('dwsnapwarning')===undefined) {
        swal({
            title: "Plugin Disclaimer",
            text: "Be advised that this plugin is in active development and targeted towards advanced users with a solid understanding of Linux systems.<br><br>If you do not know what a mount point is, are not comfortable with using a command line or unable to come up yourself with solutions for any self-induced OS-related problems, please do not use this plugin.<br><br>Understand that no software is perfect and that software of this nature in particular <u>should only ever be used on backed up data</u> and in combination with a solid backup strategy. Parity is not a backup.<br><br>While this software has been tested with the utmost diligence, its authors cannot be held responsible for any incurred data losses.",
            type: "info",
            confirmButtonText: "Proceed",
            showCancelButton: true,
            cancelButtonText: "Go Back",
            html: true
            },
            function(isConfirmed){
                if(isConfirmed) {
                    $.cookie('dwsnapwarning', 'seen', { expires: 3650 });
                } else {
                    location = '/Settings';
                }
            });
    }

    // dynamix plugin update api
    <?if (function_exists('plugin_update_available') && $version = plugin_update_available('dwsnap')):?>
        showNotice('SnapRAID <?=htmlspecialchars($version);?> available. <a>Update</a>','dwsnap');
        $('#user-notice a').on('click', function () {
        $('#user-notice').empty();
    });
    <?endif;?>
});
</script>
