Menu="OtherSettings"
Type="xmenu"
Title="SnapRAID"
Icon="hdd-o"
Tag="hdd-o"
Markdown="false"
---
<?
$snapraid_laststart = (file_exists("/var/log/snapraid/laststart") ? (file_get_contents("/var/log/snapraid/laststart") ?? "n/a") : "n/a");
$snapraid_lastcmd = (file_exists("/var/log/snapraid/lastcmd") ? (file_get_contents("/var/log/snapraid/lastcmd") ?? "n/a") : "n/a");
?>

<style type="text/css">
.snaplog {
    height: 400px;
    max-height: 400px;
    overflow: auto;
    word-break: normal !important;
    word-wrap: normal !important;
    white-space: pre !important;
}
</style>

<table class="tablesorter shift">
<thead><tr>
<th><i id="snapstatusicon" class="fa fa-pause-circle"></i> <strong>(Last) Operation's  Output</strong></th>
<th style="text-transform: none;"><strong>Command:</strong> <em><?=$snapraid_lastcmd?></em></th>
<th style="text-transform: none;"><strong>Started:</strong> <em><?=$snapraid_laststart?></em><span style="float:right;"><strong>Refresh:</strong> <i id="logcontrol" class="fa fa-refresh fa-spin"></i></span></th>
</tr></thead>
</table>

<span id="logviewer"></span>

<form markdown="0" id="snapcommands" name="snapcommands" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" id="command" name="#command" value="">
<input class="snaprun" type="button" id="snapstatus" value="STATUS">
<input class="snaprun" type="button" id="snaplist" value="LIST">
<input class="snaprun" type="button" id="snapdiff" value="DIFF">
<input class="snaprun" type="button" id="snapdup" value="DUP">
<input class="snaprun" type="button" id="snapscrub" value="SCRUB">
<input class="snaprun" type="button" id="snapcheck" value="CHECK">
<span style="float:right;">
<input class="snaprun" type="button" id="clearoutput" value="CLEAR OUTPUT">
<input class="snaprun" type="button" id="clearlogs" value="CLEAR ALL LOGS">
<input class="snapnotrun" type="button" id="snapstop" value="STOP OPERATION">
<input class="snapnotrun" type="button" id="snapkill" value="KILL OPERATION">
</span><br>
<input class="snaprun" type="button" id="snapsync" value="SYNC">
<input class="snaprun" type="button" id="snaphashedsync" value="PREHASHED SYNC">
<input class="snaprun" type="button" id="snaptouch" value="TOUCH">
<input class="snaprun" type="button" id="snapfix" value="FIX">
<input class="snaprun" type="button" id="snapfixmissing" value="FIX MISSING">
<input class="snaprun" type="button" id="snapfixerrors" value="FIX ERRORS">
</form> 

<script type="text/javascript">
function getSnapLogs() {
    $.get('/plugins/dwsnap/include/dwsnap_logger.php',function(data) {
        if (data) { 
            $('#logviewer').html(data); 
	        var pre = $(".snaplog");
	        pre.scrollTop(pre.prop("scrollHeight"));
	    }
    });
    clearTimeout(timers.getSnapLogs);
    timers.getSnapLogs = setTimeout(getSnapLogs, 1000);
}
function getSnapStatus() {
    $.get('/plugins/dwsnap/include/dwsnap_status.php',function(data) {
        if (data) { 
            if(data === "RUNNING:YES") {
                $('#snapstatusicon').attr("class", "fa fa-play-circle");
                $('.snaprun').prop('disabled', true);
                $('.snapnotrun').prop('disabled', false);
            } else if (data === "RUNNING:NO") {
                $('#snapstatusicon').attr("class", "fa fa-pause-circle");
                $('.snaprun').prop('disabled', false);
                $('.snapnotrun').prop('disabled', true);
                $('#logcontrol').attr("class", "fa fa-refresh");
                clearTimeout(timers.getSnapLogs);
            }
	    }
    });
    clearTimeout(timers.getSnapStatus);
    timers.getSnapStatus = setTimeout(getSnapStatus, 3000);
}
function toggleSnapLogs() {
    if($('#logcontrol').attr("class") == "fa fa-refresh fa-spin") {
        $('#logcontrol').attr("class", "fa fa-refresh");
        clearTimeout(timers.getSnapLogs);
    } else {
        $('#logcontrol').attr("class", "fa fa-refresh fa-spin");
        getSnapLogs();
    }
}
$(function(){
    $('#logcontrol').click(toggleSnapLogs);

    $('#snapstatus').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/status');
        $('#snapcommands').submit();
    });
    $('#snaplist').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/list');
        $('#snapcommands').submit();
    });
    $('#snapdiff').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/diff');
        $('#snapcommands').submit();
    });
    $('#snapdup').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/dup');
        $('#snapcommands').submit();
    });
    $('#snapscrub').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/scrub');
        $('#snapcommands').submit();
    });
    $('#snapcheck').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/check');
        $('#snapcommands').submit();
    });

    $('#clearoutput').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/clearoutput');
        $('#snapcommands').submit();
    });
    $('#clearlogs').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/clearlogs');
        $('#snapcommands').submit();
    });
    $('#snapstop').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/stop');
        $('#snapcommands').submit();
    });
    $('#snapkill').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/kill');
        $('#snapcommands').submit();
    });

    $('#snapsync').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/sync');
        $('#snapcommands').submit();
    });
    $('#snaphashedsync').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/hashedsync');
        $('#snapcommands').submit();
    });
    $('#snaptouch').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/touch');
        $('#snapcommands').submit();
    });
    $('#snapfix').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/fix');
        $('#snapcommands').submit();
    });
    $('#snapfixmissing').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/fixmissing');
        $('#snapcommands').submit();
    });
    $('#snapfixerrors').click(function(){
        $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/fixerrors');
        $('#snapcommands').submit();
    });

    getSnapStatus()
    getSnapLogs();

    // dynamix plugin update api
    <?if (function_exists('plugin_update_available') && $version = plugin_update_available('dwsnap')):?>
        showNotice('SnapRAID <?=htmlspecialchars($version);?> available. <a>Update</a>','dwsnap');
        $('#user-notice a').on('click', function () {
        $('#user-notice').empty();
    });
    <?endif;?>
});
</script>
