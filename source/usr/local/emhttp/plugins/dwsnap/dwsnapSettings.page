Menu="dwsnapOps:2"
Title="SnapRAID Settings"
Tag="sliders"
Markdown="false"
---
<?
/* Copyright Derek Macias (parts of code from NUT package)
 * Copyright macester (parts of code from NUT package)
 * Copyright gfjardim (parts of code from NUT package)
 * Copyright SimonF (parts of code from NUT package)
 * Copyright Dan Landon (parts of code from Web GUI)
 * Copyright Bergware International (parts of code from Web GUI)
 * Copyright Lime Technology (any and all other parts of Unraid)
 *
 * Copyright desertwitch (as author and maintainer of this file)
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License 2
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 */
require_once '/usr/local/emhttp/plugins/dwsnap/include/dwsnap_config.php';
?>

<div><strong>WARNING:</strong></div>
<div>SnapRAID is a non-supported backup utility for advanced users and can - depending on how YOU set it up - wreak havoc on your data.</div>
<div>It is crucial to make yourself familiar with the documentation before setting up SnapRAID on your system - you are warned only once here.</div>

<br>

<form markdown="0" id="dwsnap-settings" name="dwsnap_settings" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" id="sfile" name="#file" value="dwsnap/dwsnap.cfg">
<input type="hidden" id="scmd" name="#command" value="/usr/local/emhttp/plugins/dwsnap/scripts/none">
<input type="hidden" id="sarg" name="#arg[1]" value="">

<div>
    <span class="left" style="font-size:1.1rem;letter-spacing:1px;"><strong><i class="icon fa fa-cogs"></i> GENERAL SETTINGS</strong></span>
</div><br>

<dl>
    <dt>SnapRAID Backend:</dt>
    <dd>
	    <strong><?=$dwsnap_backend?></strong>
    </dd>
</dl>

<dl>
    <dt>SnapRAID Status Footer:</dt>
    <dd>
        <select id="FOOTER" name="FOOTER" size="1">
            <?=mk_option($dwsnap_footer, "disable", "No");?>
            <?=mk_option($dwsnap_footer, "enable", "Yes");?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting will display miniature status information in the page footer, for the user to be advised of any running array operations and overdue array maintenance.</p>
<p>A warning will be shown if one or more disks are not mounted or if either of the array maintenance operations (sync or scrub) have not been performed in the last 7 days.</p>
<p>An exception to the 7 day reminder to SYNC is when a more recent DIFF (either manual or as part of SnapRAID maintenance) has determined the array data has not changed since the last (overdue) SYNC.</p>
</blockquote>

<?if(version_compare(parse_ini_file('/etc/unraid-version')['version'],'6.12.0-beta5', '>')):?>
<dl>
    <dt>SnapRAID Front Page Dashboards:</dt>
    <dd>
        <select id="DASHBOARDS" name="DASHBOARDS" size="1">
            <?=mk_option($dwsnap_dashboards, "disable", "No");?>
            <?=mk_option($dwsnap_dashboards, "enable", "Yes");?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting controls if any front page dashboards with useful information should be shown at all.</p>
<p>Individual, per-array settings can be configured for each array, this setting just controls the global behavior.</p>
</blockquote>
<?endif;?>

<dl>
    <dt>SnapRAID Background Image:</dt>
    <dd>
        <select id="SCREENIMG" name="SCREENIMG" size="1">
            <?=mk_option($dwsnap_screenimg, "disable", "No");?>
            <?=mk_option($dwsnap_screenimg, "enable", "Yes");?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting controls if an eye-candy background image should be shown behind the array operation screen.</p>
</blockquote>

<dl>
    <dt>SnapRAID Synchronize Array Shutdowns:</dt>
    <dd>
        <select id="STOPARRAY" name="STOPARRAY" size="1">
            <?=mk_option($dwsnap_stoparray, "disable", "No");?>
            <?=mk_option($dwsnap_stoparray, "enable", "Yes");?>
        </select>
        <span style="margin-left:10px;"><i class="fa fa-exclamation-triangle snaphelptip" title="Keep this setting enabled unless having read and fully understood the help description."></i></span>
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting controls if running SnapRAID operations should also be stopped when the Unraid array itself is stopping, regardless if triggered manually or as part of a system shutdown.</p>
<p><strong>Keep this setting enabled if one or more of the disks configured with SnapRAID are also used in the Unraid array, as it will prevent data corruption and hard exits when Unraid is unmounting array disks.</strong></p>
<p>If all data, parity and content files are exclusively on disks that are not part of the Unraid array, this setting can be disabled in order to not interrupt running SnapRAID operations when the Unraid array is stopping.</p>
<p>Regardless of this setting during a system shutdown SnapRAID will always attempt to gracefully stop any running array operations before, as a last resort, hard-killing any non-responsive and hanging array operations.</p>
</blockquote>

<dl>
    <dt>SnapRAID Running Operation Hard-Kill Timeout:</dt>
    <dd>
        <input id="KILLTIME" type="text" class="narrow" name="KILLTIME" maxlength="30" value="<?=$dwsnap_killtime?>">seconds
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting controls after what time any still running, not-exiting SnapRAID operations should eventually be hard-killed with SIGKILL when the server shuts down.</p>
<p>If <strong><em>Synchronize Array Shutdowns</em></strong> is enabled, this is also the timeout used for any still running, not-exiting SnapRAID operations when the Unraid array is being stopped.</p>
<p>Setting <u>too short timeouts may result in data corruption</u> (SnapRAID not being able to gracefully finish up), too long timeouts may delay array/system shutdown unnecessarily (UPS: consider battery runtime).</p>
<p>In critical situations the system may or may not deem it necessary to kill still running processes anyhow - the plugin has no further control over such system behavior, although this should generally be a very rare occurence.</p>
</blockquote>

<dl>
    <dt><strong>SnapRAID Active Array Configuration (in GUI):</strong></dt>
    <dd>
        <select id="SELARRAY" name="SELARRAY" size="1">
            <?=dwsnap_array_options($dwsnap_active_cfg->cfgname);?>
        </select>
        <span style="margin-left:10px;">.conf</span>
    </dd>
</dl>

<blockquote class="inline_help">
<p>Select the array configuration to perform array operations on and/or modify the array-specific settings in GUI.</p>
</blockquote>

<dl>
    <dt>
        <input id="RESETCONF" class="snapanyrun" type="button" value="Reset Configuration">
    </dt>
    <dd>
        <input type="submit" id="btnApply" name="#apply" value="Apply">
        <input type="button" value="Done" onclick="done()">
    </dd>
</dl>

</form>

<form markdown="0" id="dwsnap-asettings" name="dwsnap_asettings" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" name="#file" value="dwsnap/config/<?=$dwsnap_active_cfg->cfgname;?>.cfg">
<input type="hidden" name="#command" value="/usr/local/emhttp/plugins/dwsnap/scripts/write_config">

<hr>

<div>
    <span class="left" style="font-size:1.1rem;letter-spacing:1px;"><strong><i class="icon fa fa-cogs"></i>(<?=strtoupper($dwsnap_active_cfg->cfgname);?>) ARRAY-SPECIFIC SETTINGS</strong></span>
</div><br>

<dl>
    <dt>SnapRAID I/O Process Priority:</dt>
    <dd>
        <select class="snaprun" id="PRIO" name="PRIO" size="1">
            <?=mk_option($dwsnap_active_cfg->prio, "disable", "System Default");?>
            <?=mk_option($dwsnap_active_cfg->prio, "idle", "Idle");?>
            <?=mk_option($dwsnap_active_cfg->prio, "besteffort", "Best Effort");?>
            <?=mk_option($dwsnap_active_cfg->prio, "realtime", "Real Time");?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting controls how much SnapRAID interferes with other running I/O (data transfer) operations (using the <em>ionice</em> program).</p>
<p>If you are running SnapRAID array operations or maintenance during the day, it is recommended to choose e.g. 'Idle' as a low-interference process priority.</p>
<p>This will ensure that other processes accessing your array will be given I/O priority over SnapRAID itself, which will in turn run slower (for its array operations).</p>
<p>This setting only has an effect with I/O schedulers respecting I/O process priorities, such as the BFQ scheduler (which can be configured under Unraid's <em>Disk Settings</em>).</p>
</blockquote>

<?if(version_compare(parse_ini_file('/etc/unraid-version')['version'],'6.12.0-beta5', '>')):?>
<dl>
    <dt>SnapRAID Array Front Page Dashboard:</dt>
    <dd>
        <select class="snaprun" id="DASHBOARD" name="DASHBOARD" size="1">
            <?=mk_option($dwsnap_active_cfg->dashboard, "disable", "No");?>
            <?=mk_option($dwsnap_active_cfg->dashboard, "enable", "Yes");?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting controls if a front page dashboard with useful information should be shown for this array.</p>
</blockquote>
<?endif;?>

<dl>
    <dt>SnapRAID Sync Overdue Warning Threshold:</dt>
    <dd>
        <select class="snaprun" id="SYNCEXPIRES" name="SYNCEXPIRES" size="1">
            <?=dwsnap_threshold_options($dwsnap_active_cfg->sync_expires);?>
        </select>
        <span style="margin-left:10px;">days</span>
    </dd>
</dl>

<blockquote class="inline_help">
<p>The amount of days since the last SYNC operation, after which a warning will be shown in the GUI (on this page and the footer).</p>
<p>The SYNC overdue warning can either be cleared or will not be shown if a more recent DIFF operation has resulted in no data differences.</p>
</blockquote>

<dl>
    <dt>SnapRAID Scrub Overdue Warning Threshold:</dt>
    <dd>
        <select class="snaprun" id="SCRUBEXPIRES" name="SCRUBEXPIRES" size="1">
            <?=dwsnap_threshold_options($dwsnap_active_cfg->scrub_expires);?>
        </select>
        <span style="margin-left:10px;">days</span>
    </dd>
</dl>

<blockquote class="inline_help">
<p>The amount of days since the last SCRUB operation, after which a warning will be shown in the GUI (on this page and the footer).</p>
</blockquote>

<dl>
    <dt>SnapRAID Write Raw Operation Reports:</dt>
    <dd>
        <select class="snaprun" id="RAWREPORTS" name="RAWREPORTS" size="1">
            <?=mk_option($dwsnap_active_cfg->rawreports, "disable", "Never");?>
            <?=mk_option($dwsnap_active_cfg->rawreports, "enable", "Always");?>
            <?=mk_option($dwsnap_active_cfg->rawreports, "manual", "Manual Operations");?>
            <?=mk_option($dwsnap_active_cfg->rawreports, "cron", "Maintenance Operations");?>
        </select>
        <span style="margin-left:10px;"><i class="fa fa-exclamation-triangle snaphelptip" title="Keep this setting disabled unless having read and fully understood the help description."></i></span>
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting controls if raw operation reports should be written to SnapRAID's RAM disk, in addition to the regular summarized (and smaller) operation logs.</p>
<p>These reports can provide additional diagnostic details, but can also be extremely large in size (up to many GBs) and possibly exceed the RAM disk's capacities.</p>
<p><strong>It is therefore recommended to keep this setting disabled, unless running into problems and needing such diagnostic information, on any systems with limited RAM reserves.</strong></p>
<p>You can also keep this setting generally disabled, but enable on demand (for individual operations) raw operation reports to another (less space constrained) location by utilizing the additional parameters above.</p>
</blockquote>

<dl>
    <dt><strong>SnapRAID Maintenance - Schedule:</strong></dt>
    <dd>
        <select class="snaprun" id="CRON" name="CRON" size="1">
            <?=mk_option($dwsnap_active_cfg->cron, "disable", "Never");?>
            <?=mk_option($dwsnap_active_cfg->cron, "hourly", "Hourly");?>
            <?=mk_option($dwsnap_active_cfg->cron, "daily", "Daily");?>
            <?=mk_option($dwsnap_active_cfg->cron, "weekly", "Weekly");?>
            <?=mk_option($dwsnap_active_cfg->cron, "monthly", "Monthly");?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting controls how often the SnapRAID maintenance will be performed.</p>
<p>As a bare minimum it is recommended to frequently scrub the array in order to detect data corruption and other anomalies.</p>
</blockquote>

<div id="CRONDOWSETTING">
    <dl>
        <dt>SnapRAID Maintenance - Schedule Day of Week:</dt>
        <dd>
            <select class="snaprun" id="CRONDOW" name="CRONDOW" size="1">
                <?=mk_option($dwsnap_active_cfg->crondow, "0", "Sunday");?>
                <?=mk_option($dwsnap_active_cfg->crondow, "1", "Monday");?>
                <?=mk_option($dwsnap_active_cfg->crondow, "2", "Tuesday");?>
                <?=mk_option($dwsnap_active_cfg->crondow, "3", "Wednesday");?>
                <?=mk_option($dwsnap_active_cfg->crondow, "4", "Thursday");?>
                <?=mk_option($dwsnap_active_cfg->crondow, "5", "Friday");?>
                <?=mk_option($dwsnap_active_cfg->crondow, "6", "Saturday");?>
            </select>
        </dd>
    </dl>
</div>

<div id="CRONDOMSETTING">
    <dl>
        <dt>SnapRAID Maintenance - Schedule Day of Month:</dt>
        <dd>
            <select class="snaprun" id="CRONDOM" name="CRONDOM" size="1">
                <?=dwsnap_dom_options($dwsnap_active_cfg->crondom);?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>Beware that not all months of the year have more than 28 days.</p>
    </blockquote>
</div>

<div id="CRONHOURSETTING">
    <dl>
        <dt>SnapRAID Maintenance - Schedule Hour:</dt>
        <dd>
            <select class="snaprun" id="CRONHOUR" name="CRONHOUR" size="1">
                <?=dwsnap_hour_options($dwsnap_active_cfg->cronhour);?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>It is recommended to pick a time when ideally no other I/O (data transfer) operations are also happening.</p>
    <p>For example if the <em>mover</em> always runs at 03:40am, maybe perform the SnapRAID maintenance at 01:00am to be safe.</p>
    </blockquote>
</div>

<div id="CRONSETTINGS">
    <dl>
        <dt>SnapRAID Maintenance - Started Notifications:</dt>
        <dd>
            <select class="snaprun" id="STARTNOTIFY" name="STARTNOTIFY" size="1">
                <?=mk_option($dwsnap_active_cfg->startnotify, "disable", "No");?>
                <?=mk_option($dwsnap_active_cfg->startnotify, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>When enabled you will receive notifications when the array maintenance starts.</p>
    <p>The notifications will be delivered according to Unraid's system-wide notification settings.</p>
    </blockquote>

    <dl>
        <dt>SnapRAID Maintenance - Finished Notifications:</dt>
        <dd>
            <select class="snaprun" id="FINISHNOTIFY" name="FINISHNOTIFY" size="1">
                <?=mk_option($dwsnap_active_cfg->finishnotify, "disable", "No");?>
                <?=mk_option($dwsnap_active_cfg->finishnotify, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>When enabled you will receive notifications when the array maintenance finishes (regardless of success or failure).</p>
    <p>The notifications will be delivered according to Unraid's system-wide notification settings.</p>
    </blockquote>

    <dl>
        <dt>SnapRAID Maintenance - Failure Notifications:</dt>
        <dd>
            <select class="snaprun" id="ERRORNOTIFY" name="ERRORNOTIFY" size="1">
                <?=mk_option($dwsnap_active_cfg->errornotify, "disable", "No");?>
                <?=mk_option($dwsnap_active_cfg->errornotify, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>When enabled you will receive notifications when the array maintenance encounters any failures (errors).</p>
    <p>This setting can be useful when <strong><em>Finished Notifications</em></strong> are disabled and you want to be notified only of array maintenance failures (errors).</p>
    <p>The notifications will be delivered according to Unraid's system-wide notification settings.</p>
    </blockquote>

    <dl>
        <dt>SnapRAID Maintenance - Disable Progress in Logfiles:</dt>
        <dd>
            <select class="snaprun" id="NOPROGRESS" name="NOPROGRESS" size="1">
                <?=mk_option($dwsnap_active_cfg->noprogress, "disable", "No");?>
                <?=mk_option($dwsnap_active_cfg->noprogress, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>When enabled repetitive progress output will not be written to the SnapRAID maintenance logfiles.</p>
    <p>On the one hand progress output can be useful to see how the operations are proceeding, but it might also make it harder to read other recorded messages.</p>
    </blockquote>

    <hr>

    <dl>
        <dt><strong>SnapRAID Maintenance - <u>Touch</u> (Step 1):</strong></dt>
        <dd>
            <select class="snaprun" id="TOUCH" name="TOUCH" size="1">
                <?=mk_option($dwsnap_active_cfg->touch, "disable", "No");?>
                <?=mk_option($dwsnap_active_cfg->touch, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>Sets arbitrarily the sub-second time-stamp of all the files that have it at zero.</p>
    <p>This improves the SnapRAID capability to recognize moved and copied files as it makes the time-stamp almost unique, removing possible duplicates.</p> 
    </blockquote>

    <dl>
        <dt><strong>SnapRAID Maintenance - <u>Diff</u> / Check Thresholds (Step 2):</strong></dt>
        <dd>
            <select class="snaprun" id="DIFF" name="DIFF" size="1">
                <?=mk_option($dwsnap_active_cfg->diff, "disable", "No");?>
                <?=mk_option($dwsnap_active_cfg->diff, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>This setting controls if the array maintenance should proceed when a certain portion of the array has changed.</p>
    <p>This is a safeguard against automated array maintenance being performed on a wiped out or otherwise corrupted array.</p>
    <p>It is important to set reasonable numbers here, so corruption and large-scale unwanted changes do not make it into the snapshots.</p>
    <p>Beware that a value of zero means that no change is acceptable (= always exit on changes), a negative value means that any amount of changes are acceptable (= never exit on changes).</p>
    </blockquote>

    <div id="THRESHOLDSETTINGS">
        <dl>
            <dt>SnapRAID Maintenance - Added Files Threshold:</dt>
            <dd>
                <input id="ADDED" type="text" class="narrow snaprun" name="ADDED" maxlength="30" value="<?=$dwsnap_active_cfg->added?>">files
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>It is important to set reasonable numbers here, so corruption and large-scale unwanted changes do not make it into the snapshots.</p>
        <p>Beware that a value of zero means that no change is acceptable (= always exit on changes), a negative value means that any amount of changes are acceptable (= never exit on changes).</p>
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Deleted Files Threshold:</dt>
            <dd>
                <input id="DELETED" type="text" class="narrow snaprun" name="DELETED" maxlength="30" value="<?=$dwsnap_active_cfg->deleted?>">files
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>It is important to set reasonable numbers here, so corruption and large-scale unwanted changes do not make it into the snapshots.</p>
        <p>Beware that a value of zero means that no change is acceptable (= always exit on changes), a negative value means that any amount of changes are acceptable (= never exit on changes).</p>
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Updated Files Threshold:</dt>
            <dd>
                <input id="UPDATED" type="text" class="narrow snaprun" name="UPDATED" maxlength="30" value="<?=$dwsnap_active_cfg->updated?>">files
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>It is important to set reasonable numbers here, so corruption and large-scale unwanted changes do not make it into the snapshots.</p>
        <p>Beware that a value of zero means that no change is acceptable (= always exit on changes), a negative value means that any amount of changes are acceptable (= never exit on changes).</p>
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Moved Files Threshold:</dt>
            <dd>
                <input id="MOVED" type="text" class="narrow snaprun" name="MOVED" maxlength="30" value="<?=$dwsnap_active_cfg->moved?>">files
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>It is important to set reasonable numbers here, so corruption and large-scale unwanted changes do not make it into the snapshots.</p>
        <p>Beware that a value of zero means that no change is acceptable (= always exit on changes), a negative value means that any amount of changes are acceptable (= never exit on changes).</p>
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Copied Files Threshold:</dt>
            <dd>
                <input id="COPIED" type="text" class="narrow snaprun" name="COPIED" maxlength="30" value="<?=$dwsnap_active_cfg->copied?>">files
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>It is important to set reasonable numbers here, so corruption and large-scale unwanted changes do not make it into the snapshots.</p>
        <p>Beware that a value of zero means that no change is acceptable (= always exit on changes), a negative value means that any amount of changes are acceptable (= never exit on changes).</p>
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Restored Files Threshold:</dt>
            <dd>
                <input id="RESTORED" type="text" class="narrow snaprun" name="RESTORED" maxlength="30" value="<?=$dwsnap_active_cfg->restored?>">files
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>It is important to set reasonable numbers here, so corruption and large-scale unwanted changes do not make it into the snapshots.</p>
        <p>Beware that a value of zero means that no change is acceptable (= always exit on changes), a negative value means that any amount of changes are acceptable (= never exit on changes).</p>
        </blockquote>

    </div>

    <dl>
        <dt><strong>SnapRAID Maintenance - <u>Sync</u> (Step 3):</strong></dt>
        <dd>
            <select class="snaprun" id="SYNC" name="SYNC" size="1">
                <?=mk_option($dwsnap_active_cfg->sync, "disable", "No");?>
                <?=mk_option($dwsnap_active_cfg->sync, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>This setting controls if a new array snapshot should be taken (overwriting the previous snapshot).</p>
    <p>It is recommended to only enable this setting when difference checking and thresholds are also in effect (as configured above).</p>
    <p>When enabled it is important to set the maintenance schedule hour to a time when ideally no writes are performed on the protected disks.</p>
    </blockquote>

    <div id="SYNCSETTINGS">
        <dl>
            <dt>SnapRAID Maintenance - Sync Zero Size Files:</dt>
            <dd>
                <select class="snaprun" id="FORCEZERO" name="FORCEZERO" size="1">
                    <?=mk_option($dwsnap_active_cfg->forcezero, "disable", "No");?>
                    <?=mk_option($dwsnap_active_cfg->forcezero, "enable", "Yes");?>
                </select>
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>Forces the insecure operation of syncing a file with zero size that before was not.</p>
        <p>If SnapRAID detects a such condition, it stops proceeding unless you specify this option.</p>
        <p>This allows to easily detect when after a system crash, some accessed files were truncated.</p>
        <p>This, however, can also be a normal possible condition in Linux with e.g. the ext3/ext4 file-systems.</p>
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Sync as Prehashed Sync:</dt>
            <dd>
                <select class="snaprun" id="PREHASH" name="PREHASH" size="1">
                    <?=mk_option($dwsnap_active_cfg->prehash, "disable", "No");?>
                    <?=mk_option($dwsnap_active_cfg->prehash, "enable", "Yes");?>
                </select>
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>When enabled a preliminary hashing phase of all the new data (to have an additional verification before the parity computation) will be performed.</p>
        <p>This can be useful to detect corruption and bit-flips during parity computation (when the machine is under heavy load), it will however take longer than a regular sync.</p> 
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Sync I/O Premature Interrupt:</dt>
            <dd>
                <input id="SYNCERRORS" type="text" class="narrow snaprun" name="SYNCERRORS" maxlength="30" value="<?=$dwsnap_active_cfg->sync_errors?>">errors
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>SnapRAID maintenance will <u><strong>never</strong></u> proceed <u><strong>to the next step</strong></u> when the previously running individual operation experienced even a single error.</p>
        <p>However, SnapRAID by default allows up to 100 I/O errors to actually try to finish such a (failing) individual operation, instead of interrupting it prematurely.</p>
        <p>I/O errors usually signify a failing disk - this setting modifies the threshold at which SnapRAID will interrupt prematurely an individual (failing) operation.</p>
        <p><strong>It is recommended to leave this setting on the default value.</strong></p>
        </blockquote>
    </div>

    <dl>
        <dt><strong>SnapRAID Maintenance - <u>Scrub</u> (Step 4):</strong></dt>
        <dd>
            <select class="snaprun" id="SCRUB" name="SCRUB" size="1">
                <?=mk_option($dwsnap_active_cfg->scrub, "disable", "No");?>
                <?=mk_option($dwsnap_active_cfg->scrub, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>Possibly the most important array operation to perform on a regular - as often as possible - basis.</p>
    <p>This operation checks your array for corruption and other anomalies, any reported errors can then be fixed with e.g. 'Fix Errors'.</p>
    <p>Scrub is not performed on the whole array at once, but rather in alternating chunks every time a scrub is performed (eventually resulting in the complete array having been scrubbed).</p>
    </blockquote>

    <div id="SCRUBSETTINGS">
        <dl>
            <dt>SnapRAID Maintenance - Scrub Age:</dt>
            <dd>
                <input id="SCRUBAGE" type="text" class="narrow snaprun" name="SCRUBAGE" maxlength="30" value="<?=$dwsnap_active_cfg->scrubage?>">days
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>The minimum age in days for a block to be scrubbed during a single scrub operation.</p>
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Scrub Percentage:</dt>
            <dd>
                <input id="SCRUBPERCENT" type="text" class="narrow snaprun" name="SCRUBPERCENT" maxlength="30" value="<?=$dwsnap_active_cfg->scrubpercent?>">%
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>The percentage of the array to be scrubbed during a single scrub operation.</p>
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Scrub Also New Blocks:</dt>
            <dd>
                <select class="snaprun" id="SCRUBNEW" name="SCRUBNEW" size="1">
                    <?=mk_option($dwsnap_active_cfg->scrubnew, "disable", "No");?>
                    <?=mk_option($dwsnap_active_cfg->scrubnew, "enable", "Yes");?>
                </select>
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>By default newly synced blocks are not instantly scrubbed due to being at lower risk for data corruption.</p>
        <p>When enabled an additional scrub operation is performed scrubbing also any newly synced blocks, in addition to the older blocks to be scrubbed.</p>
        <p>Be advised that when enabled and no scrubs have been performed on the array yet (ever), this will result in the whole array being scrubbed (as all blocks will be considered new).</p> 
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Scrub I/O Premature Interrupt:</dt>
            <dd>
                <input id="SCRUBERRORS" type="text" class="narrow snaprun" name="SCRUBERRORS" maxlength="30" value="<?=$dwsnap_active_cfg->scrub_errors?>">errors
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>SnapRAID maintenance will <u><strong>never</strong></u> proceed <u><strong>to the next step</strong></u> when the previously running individual operation experienced even a single error.</p>
        <p>However, SnapRAID by default allows up to 100 I/O errors to actually try to finish such a (failing) individual operation, instead of interrupting it prematurely.</p>
        <p>I/O errors usually signify a failing disk - this setting modifies the threshold at which SnapRAID will interrupt prematurely an individual (failing) operation.</p>
        <p><strong>It is recommended to leave this setting on the default value.</strong></p>
        </blockquote>
    </div>
</div>

<dl>
    <dt>
        <input id="NEWARRAY" type="button" value="Create New Array">
        <input id="DELARRAY" class="snaprun" type="button" value="Delete This Array">
    </dt>
    <dd>
        <input type="submit" id="btnApply2" name="#apply" value="Apply">
        <input type="button" value="Done" onclick="done()">
    </dd>
</dl>

</form>

<script type="text/javascript">
function snapCronSettings() {
    if ($("#DIFF").val() === "enable") {
        $("#THRESHOLDSETTINGS").show();
    } else {
        $("#THRESHOLDSETTINGS").hide();
    }
    if ($("#SYNC").val() === "enable") {
        $("#SYNCSETTINGS").show();
    } else {
        $("#SYNCSETTINGS").hide();
    }
    if ($("#SCRUB").val() === "enable") {
        $("#SCRUBSETTINGS").show();
    } else {
        $("#SCRUBSETTINGS").hide();
    }
    if ($("#CRON").val() === "hourly") {
        $("#CRONSETTINGS").show();
        $("#CRONHOURSETTING").hide();
        $("#CRONDOWSETTING").hide();
        $("#CRONDOMSETTING").hide();
    } else if ($("#CRON").val() === "daily") {
        $("#CRONSETTINGS").show();
        $("#CRONHOURSETTING").show();
        $("#CRONDOWSETTING").hide();
        $("#CRONDOMSETTING").hide();
    } else if ($("#CRON").val() === "weekly") {
        $("#CRONSETTINGS").show();
        $("#CRONHOURSETTING").show();
        $("#CRONDOWSETTING").show();
        $("#CRONDOMSETTING").hide();
    } else if ($("#CRON").val() === "monthly") {
        $("#CRONSETTINGS").show();
        $("#CRONHOURSETTING").show();
        $("#CRONDOWSETTING").hide();
        $("#CRONDOMSETTING").show();
    } else {
        $("#CRONSETTINGS").hide();
        $("#CRONHOURSETTING").hide();
        $("#CRONDOWSETTING").hide();
        $("#CRONDOMSETTING").hide();
    }
}
$(function(){
    $('#RESETCONF').click(function(){
        swal({
            title: "Are you sure?",
            text: "This action will reset the plugin to its default state.<br>All the array configurations are also reset (do take note of them).",
            type: "error",
            showCancelButton: true,
            confirmButtonText: "Reset Configuration",
            html: true
            },
            function(){
                $('#sfile').remove();
                $('#scmd').val('/usr/local/emhttp/plugins/dwsnap/scripts/reset_config');
                $('#sarg').val('');
                $('#dwsnap-settings').submit();
            });
    });

    $('#NEWARRAY').click(function(){
        swal({
            title: "New Array Configuration",
            text: "Please choose a name for your new array configuration:",
            type: "input",
            showCancelButton: true,
            confirmButtonText: "Create Array",
            html: true,
            inputPlaceholder: "Alphanumeric - no spaces or special characters!",
            closeOnConfirm: false
            },
            function(value){
                if(value !== false && value !== "") {
                    var format = /[ `!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/;
                    if(format.test(value)) {
                        swal("Operation Failure", "The chosen array name contained disallowed characters.", "error");
                    }
                    else {
                        $('#sfile').remove();
                        $('#scmd').val('/usr/local/emhttp/plugins/dwsnap/scripts/create_array');
                        $('#sarg').val(value);
                        $('#dwsnap-settings').submit();
                    }
                }
            });
    });

    $('#DELARRAY').click(function(){
        if("<?=$dwsnap_active_cfg->cfgname;?>" == "primary") {
            swal("Operation Failure", "You cannot delete the primary array configuration.", "error");
        }
        else {
            swal({
                title: "Are you sure?",
                text: "This action will <u>delete</u> the array configuration: <span style='font-weight:bold;'><?=strtoupper($dwsnap_active_cfg->cfgname);?></span>.<br>The data on the array will remain untouched and not be deleted.",
                type: "error",
                showCancelButton: true,
                confirmButtonText: "Delete Array",
                html: true
                },
                function(){
                    $('#sfile').remove();
                    $('#scmd').val('/usr/local/emhttp/plugins/dwsnap/scripts/delete_array');
                    $('#sarg').val('<?=$dwsnap_active_cfg->cfgname;?>');
                    $('#dwsnap-settings').submit();
                });
            }
    });

    $("#DIFF").change(snapCronSettings);
    $("#SYNC").change(snapCronSettings);
    $("#SCRUB").change(snapCronSettings);
    $("#CRON").change(snapCronSettings);
    snapCronSettings();
});
</script>
    
