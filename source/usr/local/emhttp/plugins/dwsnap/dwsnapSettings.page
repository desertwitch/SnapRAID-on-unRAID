Menu="dwsnapOps:1"
Title="SnapRAID Settings"
Tag="cogs"
Markdown="false"
---
<?
/* Copyright Derek Macias (parts of code from NUT package)
 * Copyright macester (parts of code from NUT package)
 * Copyright gfjardim (parts of code from NUT package)
 * Copyright SimonF (parts of code from NUT package)
 * Copyright desertwitch
 *
 * Copyright Dan Landon
 * Copyright Bergware International
 * Copyright Lime Technology
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License 2
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 */
require_once '/usr/local/emhttp/plugins/dwsnap/include/dwsnap_config.php';
?>

<div><strong>WARNING:</strong></div>
<div>SnapRAID is a non-supported backup utility for advanced users and can - depending on how YOU set it up - wreak havoc on your data.</div>
<div>It is crucial to make yourself familiar with the documentation before setting up SnapRAID on your system - you are warned only once here.</div>

<br>

<form markdown="0" id="dwsnap-settings" name="dwsnap_settings" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" name="#file" value="dwsnap/dwsnap.cfg">
<input type="hidden" id="command2" name="#command" value="/usr/local/emhttp/plugins/dwsnap/scripts/write_config">
<dl>
    <dt>SnapRAID Backend:</dt>
    <dd>
	    <strong><?= isset($dwsnap_backend) && $dwsnap_backend ? $dwsnap_backend : "n/a" ?></strong>
    </dd>
</dl>

<dl>
    <dt>SnapRAID I/O Process Priority:</dt>
    <dd>
        <select class="snaprun" id="PRIO" name="PRIO" size="1">
            <?=mk_option($dwsnap_prio, "disable", "System Default");?>
            <?=mk_option($dwsnap_prio, "idle", "Idle");?>
            <?=mk_option($dwsnap_prio, "besteffort", "Best Effort");?>
            <?=mk_option($dwsnap_prio, "realtime", "Real Time");?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting controls how much SnapRAID interferes with other running I/O (data transfer) operations (using <em>ionice</em>).</p>
<p>If you are running SnapRAID during the day it is recommended to choose 'Idle' as low-interference process priority.</p>
<p>This will ensure that other processes accessing your array will be given priority over SnapRAID itself, which will in turn run slower.</p>
</blockquote>

<dl>
    <dt>SnapRAID Status Footer:</dt>
    <dd>
        <select class="snaprun" id="FOOTER" name="FOOTER" size="1">
            <?=mk_option($dwsnap_footer, "disable", "No");?>
            <?=mk_option($dwsnap_footer, "enable", "Yes");?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting will display miniature status information in the page footer, for the user to be advised of any running array operations and overdue array maintenance.</p>
<p>A warning will be shown if one or more disks are not mounted or if either of the array maintenance operations (sync or scrub) have not been performed in the last 7 days.</p>
</blockquote>

<hr>

<dl>
    <dt><strong>SnapRAID Maintenance - Schedule:</strong></dt>
    <dd>
        <select class="snaprun" id="CRON" name="CRON" size="1">
            <?=mk_option($dwsnap_cron, "disable", "Never");?>
            <?=mk_option($dwsnap_cron, "hourly", "Hourly");?>
            <?=mk_option($dwsnap_cron, "daily", "Daily");?>
            <?=mk_option($dwsnap_cron, "weekly", "Weekly");?>
            <?=mk_option($dwsnap_cron, "monthly", "Monthly");?>
        </select>
    </dd>
</dl>

<blockquote class="inline_help">
<p>This setting controls how often the SnapRAID maintenance will be performed.</p>
<p>As a bare minimum it is recommended to frequently scrub the array in order to detect data corruption and other anomalies.</p>
</blockquote>

<div id="CRONDOWSETTING">
    <dl>
        <dt>SnapRAID Maintenance - Schedule Day of Week:</dt>
        <dd>
            <select class="snaprun" id="CRONDOW" name="CRONDOW" size="1">
                <?=mk_option($dwsnap_crondow, "0", "Sunday");?>
                <?=mk_option($dwsnap_crondow, "1", "Monday");?>
                <?=mk_option($dwsnap_crondow, "2", "Tuesday");?>
                <?=mk_option($dwsnap_crondow, "3", "Wednesday");?>
                <?=mk_option($dwsnap_crondow, "4", "Thursday");?>
                <?=mk_option($dwsnap_crondow, "5", "Friday");?>
                <?=mk_option($dwsnap_crondow, "6", "Saturday");?>
            </select>
        </dd>
    </dl>
</div>

<div id="CRONDOMSETTING">
    <dl>
        <dt>SnapRAID Maintenance - Schedule Day of Month:</dt>
        <dd>
            <select class="snaprun" id="CRONDOM" name="CRONDOM" size="1">
                <? echo dwsnap_dom_options($dwsnap_crondom);?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>Beware that not all months of the year have more than 28 days.</p>
    </blockquote>
</div>

<div id="CRONHOURSETTING">
    <dl>
        <dt>SnapRAID Maintenance - Schedule Hour:</dt>
        <dd>
            <select class="snaprun" id="CRONHOUR" name="CRONHOUR" size="1">
                <? echo dwsnap_hour_options($dwsnap_cronhour);?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>It is recommended to pick a time when ideally no other I/O (data transfer) operations are also happening.</p>
    <p>For example if the <em>mover</em> always runs at 03:40am, maybe perform the SnapRAID maintenance at 01:00am to be safe.</p>
    </blockquote>
</div>

<div id="CRONSETTINGS">
    <dl>
        <dt>SnapRAID Maintenance - Started Notifications:</dt>
        <dd>
            <select class="snaprun" id="STARTNOTIFY" name="STARTNOTIFY" size="1">
                <?=mk_option($dwsnap_startnotify, "disable", "No");?>
                <?=mk_option($dwsnap_startnotify, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>When enabled you will receive notifications when the array maintenance starts.</p>
    <p>The notifications will be delivered according to Unraid's system-wide notification settings.</p>
    </blockquote>

    <dl>
        <dt>SnapRAID Maintenance - Finished Notifications:</dt>
        <dd>
            <select class="snaprun" id="FINISHNOTIFY" name="FINISHNOTIFY" size="1">
                <?=mk_option($dwsnap_finishnotify, "disable", "No");?>
                <?=mk_option($dwsnap_finishnotify, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>When enabled you will receive notifications when the array maintenance finishes.</p>
    <p>The notifications will be delivered according to Unraid's system-wide notification settings.</p>
    </blockquote>

    <hr>

    <dl>
        <dt><strong>SnapRAID Maintenance - <u>Touch</u> (Step 1):</strong></dt>
        <dd>
            <select class="snaprun" id="TOUCH" name="TOUCH" size="1">
                <?=mk_option($dwsnap_touch, "disable", "No");?>
                <?=mk_option($dwsnap_touch, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>Sets arbitrarily the sub-second time-stamp of all the files that have it at zero.</p>
    <p>This improves the SnapRAID capability to recognize moved and copied files as it makes the time-stamp almost unique, removing possible duplicates.</p> 
    </blockquote>

    <dl>
        <dt><strong>SnapRAID Maintenance - <u>Diff</u> / Check Thresholds (Step 2):</strong></dt>
        <dd>
            <select class="snaprun" id="DIFF" name="DIFF" size="1">
                <?=mk_option($dwsnap_diff, "disable", "No");?>
                <?=mk_option($dwsnap_diff, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>This setting controls if the array maintenance should proceed when a certain portion of the array has changed.</p>
    <p>This is a safeguard against automated array maintenance being performed on a wiped out or otherwise corrupted array.</p>
    <p>It is important to set reasonable numbers here, so corruption and large-scale unwanted changes do not make it into the snapshots.</p>
    <p>Beware that a value of zero means that no change is acceptable (= always exit on changes), a negative value means that any amount of changes are acceptable (= never exit on changes).</p>
    </blockquote>

    <div id="THRESHOLDSETTINGS">
        <dl>
            <dt>SnapRAID Maintenance - Added Files Threshold:</dt>
            <dd>
                <input id="ADDED" type="text" class="narrow snaprun" name="ADDED" maxlength="30" value="<?=$dwsnap_added?>">files
            </dd>
        </dl>

        <dl>
            <dt>SnapRAID Maintenance - Deleted Files Threshold:</dt>
            <dd>
                <input id="DELETED" type="text" class="narrow snaprun" name="DELETED" maxlength="30" value="<?=$dwsnap_deleted?>">files
            </dd>
        </dl>

        <dl>
            <dt>SnapRAID Maintenance - Updated Files Threshold:</dt>
            <dd>
                <input id="UPDATED" type="text" class="narrow snaprun" name="UPDATED" maxlength="30" value="<?=$dwsnap_updated?>">files
            </dd>
        </dl>

        <dl>
            <dt>SnapRAID Maintenance - Moved Files Threshold:</dt>
            <dd>
                <input id="MOVED" type="text" class="narrow snaprun" name="MOVED" maxlength="30" value="<?=$dwsnap_moved?>">files
            </dd>
        </dl>

        <dl>
            <dt>SnapRAID Maintenance - Copied Files Threshold:</dt>
            <dd>
                <input id="COPIED" type="text" class="narrow snaprun" name="COPIED" maxlength="30" value="<?=$dwsnap_copied?>">files
            </dd>
        </dl>

        <dl>
            <dt>SnapRAID Maintenance - Restored Files Threshold:</dt>
            <dd>
                <input id="RESTORED" type="text" class="narrow snaprun" name="RESTORED" maxlength="30" value="<?=$dwsnap_restored?>">files
            </dd>
        </dl>

    </div>

    <dl>
        <dt><strong>SnapRAID Maintenance - <u>Sync</u> (Step 3):</strong></dt>
        <dd>
            <select class="snaprun" id="SYNC" name="SYNC" size="1">
                <?=mk_option($dwsnap_sync, "disable", "No");?>
                <?=mk_option($dwsnap_sync, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>This setting controls if a new array snapshot should be taken (overwriting the previous snapshot).</p>
    <p>It is recommended to only enable this setting when difference checking and thresholds are also in effect (as configured above).</p>
    <p>When enabled it is important to set the maintenance schedule hour to a time when ideally no writes are performed on the protected disks.</p>
    </blockquote>

    <div id="SYNCSETTINGS">
        <dl>
            <dt>SnapRAID Maintenance - Sync as Prehashed Sync:</dt>
            <dd>
                <select class="snaprun" id="PREHASH" name="PREHASH" size="1">
                    <?=mk_option($dwsnap_prehash, "disable", "No");?>
                    <?=mk_option($dwsnap_prehash, "enable", "Yes");?>
                </select>
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>When enabled a preliminary hashing phase of all the new data (to have an additional verification before the parity computation) will be performed.</p>
        <p>This can be useful to detect corruption and bit-flips during parity computation (when the machine is under heavy load), it will however take longer than a regular sync.</p> 
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Sync Zero Size Files:</dt>
            <dd>
                <select class="snaprun" id="FORCEZERO" name="FORCEZERO" size="1">
                    <?=mk_option($dwsnap_forcezero, "disable", "No");?>
                    <?=mk_option($dwsnap_forcezero, "enable", "Yes");?>
                </select>
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>Forces the insecure operation of syncing a file with zero size that before was not.</p>
        <p>If SnapRAID detects a such condition, it stops proceeding unless you specify this option.</p>
        <p>This allows to easily detect when after a system crash, some accessed files were truncated.</p>
        <p>This, however, can also be a normal possible condition in Linux with e.g. the ext3/ext4 file-systems.</p>
        </blockquote>
    </div>

    <dl>
        <dt><strong>SnapRAID Maintenance - <u>Scrub</u> (Step 4):</strong></dt>
        <dd>
            <select class="snaprun" id="SCRUB" name="SCRUB" size="1">
                <?=mk_option($dwsnap_scrub, "disable", "No");?>
                <?=mk_option($dwsnap_scrub, "enable", "Yes");?>
            </select>
        </dd>
    </dl>

    <blockquote class="inline_help">
    <p>Possibly the most important array operation to perform on a regular - as often as possible - basis.</p>
    <p>This operation checks your array for corruption and other anomalies, any reported errors can then be fixed with e.g. 'Fix Errors'.</p>
    <p>Scrub is not performed on the whole array at once, but rather in alternating chunks every time a scrub is performed (eventually resulting in the complete array having been scrubbed).</p>
    </blockquote>

    <div id="SCRUBSETTINGS">
        <dl>
            <dt>SnapRAID Maintenance - Scrub Age:</dt>
            <dd>
                <input id="SCRUBAGE" type="text" class="narrow snaprun" name="SCRUBAGE" maxlength="30" value="<?=$dwsnap_scrubage?>">days
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>The minimum age in days for a block to be scrubbed during a single scrub operation.</p>
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Scrub Percentage:</dt>
            <dd>
                <input id="SCRUBPERCENT" type="text" class="narrow snaprun" name="SCRUBPERCENT" maxlength="30" value="<?=$dwsnap_scrubpercent?>">%
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>The percentage of the array to be scrubbed during a single scrub operation.</p>
        </blockquote>

        <dl>
            <dt>SnapRAID Maintenance - Scrub Also New Blocks:</dt>
            <dd>
                <select class="snaprun" id="SCRUBNEW" name="SCRUBNEW" size="1">
                    <?=mk_option($dwsnap_scrubnew, "disable", "No");?>
                    <?=mk_option($dwsnap_scrubnew, "enable", "Yes");?>
                </select>
            </dd>
        </dl>

        <blockquote class="inline_help">
        <p>By default newly synced blocks are not instantly scrubbed due to being at lower risk for data corruption.</p>
        <p>When enabled an additional scrub operation is performed scrubbing also any newly synced blocks, in addition to the older blocks to be scrubbed.</p>
        <p>Be advised that when enabled and no scrubs have been performed on the array yet (ever), this will result in the whole array being scrubbed (as all blocks will be considered new).</p> 
        </blockquote>
    </div>
</div>

<dl>
    <dt>
        <input id="DEFAULT" class="snaprun" type="submit" name="#default" value="Default">
        <input id="RESETCONF" class="snaprun" type="button" value="Reset Config">
    </dt>
    <dd>
        <input type="submit" class="snaprun" id="btnApply" name="#apply" value="Apply">
        <input type="button" class="snaprun" value="Done" onclick="done()">
    </dd>
</dl>

</form>

<script type="text/javascript">
function checkCronSettings() {
    if ($("#DIFF").val() === "enable") {
        $("#THRESHOLDSETTINGS").show();
    } else {
        $("#THRESHOLDSETTINGS").hide();
    }
    if ($("#SYNC").val() === "enable") {
        $("#SYNCSETTINGS").show();
    } else {
        $("#SYNCSETTINGS").hide();
    }
    if ($("#SCRUB").val() === "enable") {
        $("#SCRUBSETTINGS").show();
    } else {
        $("#SCRUBSETTINGS").hide();
    }
    if ($("#CRON").val() === "hourly") {
        $("#CRONSETTINGS").show();
        $("#CRONHOURSETTING").hide();
        $("#CRONDOWSETTING").hide();
        $("#CRONDOMSETTING").hide();
    } else if ($("#CRON").val() === "daily") {
        $("#CRONSETTINGS").show();
        $("#CRONHOURSETTING").show();
        $("#CRONDOWSETTING").hide();
        $("#CRONDOMSETTING").hide();
    } else if ($("#CRON").val() === "weekly") {
        $("#CRONSETTINGS").show();
        $("#CRONHOURSETTING").show();
        $("#CRONDOWSETTING").show();
        $("#CRONDOMSETTING").hide();
    } else if ($("#CRON").val() === "monthly") {
        $("#CRONSETTINGS").show();
        $("#CRONHOURSETTING").show();
        $("#CRONDOWSETTING").hide();
        $("#CRONDOMSETTING").show();
    } else {
        $("#CRONSETTINGS").hide();
        $("#CRONHOURSETTING").hide();
        $("#CRONDOWSETTING").hide();
        $("#CRONDOMSETTING").hide();
    }
}
$(function(){
    $('#RESETCONF').click(function(){
        swal({
            title: "Are you sure?",
            text: "This action will reset your entire configuration.<br>Your array configuration is also reset (take note of it).",
            type: "error",
            showCancelButton: true,
            confirmButtonText: "Reset Configuration",
            html: true
            },
            function(){
                $('#command').val('/usr/local/emhttp/plugins/dwsnap/scripts/reset_config');
                $('#snapcommands').submit();
            });
    });

    $("#DIFF").change(checkCronSettings);
    $("#SYNC").change(checkCronSettings);
    $("#SCRUB").change(checkCronSettings);
    $("#CRON").change(checkCronSettings);
    checkCronSettings();
});
</script>
    
