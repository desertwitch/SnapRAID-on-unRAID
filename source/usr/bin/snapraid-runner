#!/bin/bash
SNAP_BIN="/usr/bin/snapraid"
SNAP_CONF="/etc/snapraid.conf"
CONFIG="/boot/config/plugins/dwsnap/dwsnap.cfg"

[ -e "$CONFIG" ] && source $CONFIG

[ "$PRIO" == "idle" ] && SNAP_BIN="/usr/bin/ionice -c 3 /usr/bin/snapraid"
[ "$PRIO" == "besteffort" ] && SNAP_BIN="/usr/bin/ionice -c 2 /usr/bin/snapraid"
[ "$PRIO" == "realtime" ] && SNAP_BIN="/usr/bin/ionice -c 1 /usr/bin/snapraid"

run_snapraid() {
    CMD="$1"
    BIGOP="$(echo "$1" | awk '{print toupper($0)}')"
    [ "$CMD" == "fixerrors" ] && CMD="-e fix"
    [ "$CMD" == "fixmissing" ] && CMD="-m fix"
    [ "$CMD" == "hashedsync" ] && CMD="-h sync"
    rm -f /var/log/snapraid/lastfinish
    OPTIME=$(date +"%d.%m.%Y %H:%M:%S %Z")
    echo "$OPTIME" >/var/log/snapraid/laststart
    echo "### ${BIGOP} STARTED: ${OPTIME}" 2>&1 | tee /var/log/snapraid/snaplog
    echo "### $SNAP_BIN -c $SNAP_CONF -l \"/var/log/snapraid/${1}-%D-%T.log\" ${CMD} >>/var/log/snapraid/snaplog 2>&1" 2>&1 | tee -a /var/log/snapraid/snaplog 
    echo "################################################################" 2>&1 | tee -a /var/log/snapraid/snaplog
    $SNAP_BIN -c $SNAP_CONF -l "/var/log/snapraid/${1}-%D-%T.log" $CMD 2>&1 | tee -a /var/log/snapraid/snaplog 
    OPTIME=$(date +"%d.%m.%Y %H:%M:%S %Z")
    echo "$OPTIME" >/var/log/snapraid/lastfinish
    echo "################################################################" 2>&1 | tee -a /var/log/snapraid/snaplog
    echo "### ${BIGOP} FINISHED: ${OPTIME}" 2>&1 | tee -a /var/log/snapraid/snaplog
    sleep 3
}

case "$1" in
    check)
        run_snapraid check
        ;;
    diff)
        run_snapraid diff
        ;;
    dup)
        run_snapraid dup
        ;;
    fix)
        run_snapraid fix
        ;;
    fixerrors) 
        run_snapraid fixerrors
        ;;
    fixmissing)
        run_snapraid fixmissing
        ;;
    hashedsync) 
        run_snapraid hashedsync
        ;;
    list)
        run_snapraid list
        ;;
    scrub)
        run_snapraid scrub
        ;;
    status)
        run_snapraid status
        ;;
    sync)
        run_snapraid sync
        ;;
    touch)
        run_snapraid touch
        ;;
    write_config)
        write_config
        ;;
    *)
    echo "Usage: $0 {check|diff|dup|fix|fixerrors|fixmissing|hashedsync|list|scrub|status|sync|touch}"
esac
